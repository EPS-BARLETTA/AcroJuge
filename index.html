<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>AcroJuge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f6f7fb;--card:#fff;--text:#111827;--muted:#6b7280;
      --brand:#0ea5e9;--ok:#16a34a;--warn:#f59e0b;--bad:#ef4444;--ring:#111827;
      --p2:#e0f2fe;--p3:#dcfce7;--p4:#fef3c7;--p5:#fae8ff;--libre:#f3f4f6;
      --border:#e5e7eb;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);padding:10px 16px;display:flex;gap:12px;align-items:center;justify-content:space-between;z-index:10}
    .h-title{font-weight:700}
    .btn{border:0;border-radius:12px;padding:8px 12px;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-primary{background:#16a34a;color:#fff}
    .btn-secondary{background:#e5e7eb}
    .btn-blue{background:#2563eb;color:#fff}
    .btn-purple{background:#7c3aed;color:#fff}
    .btn-yellow{background:#f59e0b;color:#111}
    .btn-danger{background:#ef4444;color:#fff}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 320px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:14px}
    .title{font-weight:600;margin-bottom:8px}
    .muted{color:var(--muted);font-size:12px}
    input[type="text"],input[type="number"],textarea,select{
      width:100%;border:1px solid var(--border);border-radius:12px;padding:10px;font-size:14px;background:#fff;
    }
    textarea{min-height:84px;resize:vertical}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .chip{background:#f3f4f6;border-radius:999px;padding:6px 10px;font-size:13px;display:inline-flex;gap:8px;align-items:center}
    .chip button{border:0;background:transparent;cursor:pointer;color:#6b7280}
    .grid{display:grid;gap:10px}
    .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .grid-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    .rangeRow{display:flex;align-items:center;gap:10px}
    .rangeRow input[type="range"]{flex:1}
    .pill{padding:6px 10px;border-radius:999px;background:#f3f4f6;font-size:12px}
    .bar{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .pyr{border:1px solid var(--border);border-radius:16px;padding:12px}
    .p2{background:var(--p2)}
    .p3{background:var(--p3)}
    .p4{background:var(--p4)}
    .p5{background:var(--p5)}
    .libre{background:var(--libre)}
    .seg{border:1px dashed var(--border);padding:8px;border-radius:12px;margin-top:8px;background:#fff}
    .fmblist button{border:0;border-radius:10px;padding:8px 10px;background:#e5e7eb;cursor:pointer}
    .fmblist button.active{outline:2px solid var(--ring);outline-offset:2px;background:#fff}
    .footerNote{margin-top:6px;font-size:12px;color:var(--muted)}
    .footer-pdf{position:fixed;bottom:8px;left:16px;right:16px;text-align:center;color:#6b7280;font-size:12px}
    .nav{display:flex;justify-content:space-between;gap:10px;margin-top:10px}
    .hidden{display:none}
    /* Print styles (fallback) */
    @media print{
      .header,.nav,.no-print{display:none!important}
      body{background:#fff}
      .card{break-inside:avoid}
      .footer-pdf{display:block!important;position:fixed;bottom:12px}
    }
  </style>
  <!-- OPTIONNEL : jsPDF local (sans CDN). Si pr√©sent, l'app utilisera l'export PDF fichier. -->
  <script>
    window.__HAS_LOCAL_JSPDF__ = false;
  </script>
  <script src="libs/jspdf.umd.min.js" onload="window.__HAS_LOCAL_JSPDF__=true" defer></script>
</head>
<body>
  <header class="header">
    <div class="row" style="align-items:center">
      <div class="h-title">ü§∏‚Äç‚ôÄÔ∏è AcroJuge</div>
      <div class="pill no-print">Mode: <span id="modeLabel">Configuration</span></div>
    </div>
    <div class="row no-print">
      <button class="btn btn-blue" id="btnExportPDF">üìÑ Export PDF</button>
      <button class="btn btn-purple" id="btnExportJSON">üíæ Export JSON</button>
      <button class="btn btn-yellow" id="btnExportCSV">‚¨áÔ∏è Export CSV</button>
    </div>
  </header>

  <main class="container">
    <!-- COVER -->
    <section id="page-cover" class="card">
      <div class="title">Bienvenue üëã</div>
      <p class="muted">Observe, juge et exporte des √©valuations d‚ÄôAcroSport. 100% local ‚Äî compatible MDM.</p>
      <div class="nav">
        <div></div>
        <button class="btn btn-primary" id="goSetup">Commencer</button>
      </div>
    </section>

    <!-- SETUP -->
    <section id="page-setup" class="card hidden">
      <div class="row">
        <div class="col card">
          <div class="title">üëÄ Observateur¬∑rice(s)</div>
          <div>
            <input type="text" id="obsInput" placeholder="ex. Ambre, L√©o" />
            <div class="chips" id="obsChips"></div>
            <div class="footerNote">Entr√©e rapide : coller une liste (s√©par√©e par virgule, point-virgule ou retour √† la ligne).</div>
          </div>
        </div>
        <div class="col card">
          <div class="title">üë• Groupe observ√© (par d√©faut)</div>
          <div>
            <input type="text" id="grpInput" placeholder="ex. In√®s, L√©o" />
            <div class="chips" id="grpChips"></div>
            <div class="footerNote">Ces pr√©noms serviront pour l‚Äô√©valuation individuelle.</div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="bar">
          <div class="title">üóìÔ∏è Plan d‚Äôencha√Ænement</div>
          <div class="muted">Compositions : <span id="compoCount">0</span></div>
        </div>
        <div class="grid grid-5" style="display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:10px;margin-top:8px">
          <div class="card p2">
            <label class="muted">Pyramide √† 2 √ó</label>
            <input type="number" min="0" id="count-p2" value="0">
          </div>
          <div class="card p3">
            <label class="muted">Pyramide √† 3 √ó</label>
            <input type="number" min="0" id="count-p3" value="0">
          </div>
          <div class="card p4">
            <label class="muted">Pyramide √† 4 √ó</label>
            <input type="number" min="0" id="count-p4" value="0">
          </div>
          <div class="card p5">
            <label class="muted">Pyramide √† 5 √ó</label>
            <input type="number" min="0" id="count-p5" value="0">
          </div>
          <div class="card libre">
            <label class="muted">Pyramide libre √ó</label>
            <input type="number" min="0" id="count-libre" value="0">
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn btn-blue" id="btnAddCompo">‚ûï Ajouter la composition</button>
          <button class="btn btn-secondary" id="btnResetCounts">R√©initialiser</button>
          <button class="btn btn-primary" id="btnStartObserve">‚ñ∂Ô∏è D√©marrer l‚Äôobservation</button>
        </div>
      </div>

      <div class="nav">
        <button class="btn btn-secondary" id="setupBack">‚¨ÖÔ∏è Pr√©c√©dent</button>
        <button class="btn btn-primary" id="setupNext">Suivant ‚û°Ô∏è</button>
      </div>
    </section>

    <!-- OBSERVATION -->
    <section id="page-observe" class="hidden">
      <div class="card">
        <div class="bar">
          <div class="title">üéØ S√©lection de composition</div>
          <div class="muted">Total : <span id="badgeTotal"></span></div>
        </div>
        <div id="compoButtons" class="row" style="margin-top:8px"></div>
      </div>

      <div id="observeContent" class="card" style="margin-top:12px"></div>

      <div class="nav">
        <button class="btn btn-secondary" id="observeBack">‚¨ÖÔ∏è Pr√©c√©dent</button>
        <button class="btn btn-primary" id="observeNext">Suivant ‚û°Ô∏è</button>
      </div>
    </section>

    <!-- EVALUATIONS (ensemble + individuel) -->
    <section id="page-evals" class="hidden">
      <div class="card">
        <div class="title">üìù √âvaluation de l‚Äôensemble (0‚Äì5)</div>
        <div id="ensembleSliders" class="grid grid-2" style="margin-top:8px"></div>
      </div>

      <div class="row" style="margin-top:12px">
        <div class="col card">
          <div class="title">üóíÔ∏è Commentaire global</div>
          <textarea id="commentaire"></textarea>
        </div>
        <div class="col card">
          <div class="title">üèÅ Note finale /20</div>
          <input type="number" id="noteFinale" min="0" max="20" value="0" />
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="title">üë§ √âvaluation individuelle</div>
        <div id="elevesList" class="grid"></div>
      </div>

      <div class="nav">
        <button class="btn btn-secondary" id="evalsBack">‚¨ÖÔ∏è Pr√©c√©dent</button>
        <div></div>
      </div>
    </section>

    <div class="footer-pdf" style="display:none">
      AcroJuge - Equipe EPS Lyc√©e Vauban - LUXEMBOURG - JB
    </div>
  </main>

<script>
/** =======================
 *  STATE & HELPERS
 *  ======================= */
const STORAGE_KEY = "acrojuge_state_v1";
const DOT = { fragile:"üî¥", moyen:"üü°", bon:"üü¢" };
const LABEL = { p2:"Pyramide √† 2", p3:"Pyramide √† 3", p4:"Pyramide √† 4", p5:"Pyramide √† 5", libre:"Pyramide libre" };
const NEED = { p2:2, p3:3, p4:4, p5:5 };
const COLORS = { p2:"p2", p3:"p3", p4:"p4", p5:"p5", libre:"libre" };
const DEFAULT_SECURITE = [
  "R√¥les d√©finis (porteurs / voltige)",
  "Prises s√ªres et alignements",
  "Mont√©e contr√¥l√©e",
  "Tenue sans danger",
  "Descente s√©curis√©e",
];

const app = {
  observers: [],
  group: [],
  counts: { p2:0, p3:0, p4:0, p5:0, libre:0 },
  evals: [],
  selectedId: null,
};

function uid(){ return Math.random().toString(36).slice(2,10); }

function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(app)); }
function load(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){ const p = JSON.parse(raw); Object.assign(app, p); }
  }catch{}
}

function toChips(container, arr, onRemove){
  container.innerHTML = "";
  arr.forEach((name, i)=>{
    const s = document.createElement("span");
    s.className = "chip";
    s.innerHTML = `<span>${name}</span>`;
    const b = document.createElement("button");
    b.textContent = "√ó";
    b.onclick = ()=>{ onRemove(i); };
    s.appendChild(b);
    container.appendChild(s);
  });
}

function splitNames(text){
  return text.replace(/\r\n?/g,"\n").split(/[ ,;\n]+/).map(s=>s.trim()).filter(Boolean);
}

function syncEleves(prev, names){
  const by = new Map((prev||[]).map(e=>[e.name,e]));
  return (names||[]).map(n=> by.get(n) || { name:n, note:0, avis:"" });
}

function makePyramide(t){
  const sec = Object.fromEntries(DEFAULT_SECURITE.map(s=>[s,"fragile"])); // F/M/B par d√©faut = fragile
  return { id: uid(), type:t, securite:sec, tenue:"non" };
}

/** =======================
 *  UI BINDINGS
 *  ======================= */
const pages = {
  cover: document.getElementById("page-cover"),
  setup: document.getElementById("page-setup"),
  observe: document.getElementById("page-observe"),
  evals: document.getElementById("page-evals"),
};
const modeLabel = document.getElementById("modeLabel");

// chips
const obsInput = document.getElementById("obsInput");
const obsChips = document.getElementById("obsChips");
const grpInput = document.getElementById("grpInput");
const grpChips = document.getElementById("grpChips");

// counts
const countInputs = {
  p2: document.getElementById("count-p2"),
  p3: document.getElementById("count-p3"),
  p4: document.getElementById("count-p4"),
  p5: document.getElementById("count-p5"),
  libre: document.getElementById("count-libre"),
};
const compoCount = document.getElementById("compoCount");

// observe
const compoButtons = document.getElementById("compoButtons");
const observeContent = document.getElementById("observeContent");
const badgeTotal = document.getElementById("badgeTotal");

// evals
const ensembleSliders = document.getElementById("ensembleSliders");
const commentaire = document.getElementById("commentaire");
const noteFinale = document.getElementById("noteFinale");
const elevesList = document.getElementById("elevesList");

// nav buttons
document.getElementById("goSetup").onclick = ()=> show("setup");
document.getElementById("setupBack").onclick = ()=> show("cover");
document.getElementById("setupNext").onclick = ()=> show("observe");
document.getElementById("observeBack").onclick = ()=> show("setup");
document.getElementById("observeNext").onclick = ()=> show("evals");
document.getElementById("evalsBack").onclick = ()=> show("observe");

// setup actions
document.getElementById("btnAddCompo").onclick = ()=> addComposition(false);
document.getElementById("btnStartObserve").onclick = ()=> addComposition(true);
document.getElementById("btnResetCounts").onclick = ()=>{
  app.counts = { p2:0,p3:0,p4:0,p5:0,libre:0 };
  renderSetup();
  save();
};

// export
document.getElementById("btnExportPDF").onclick = exportPDF;
document.getElementById("btnExportJSON").onclick = exportJSON;
document.getElementById("btnExportCSV").onclick = exportCSV;

// chips inputs
obsInput.addEventListener("keydown", (e)=>{
  if(e.key==="Enter"||e.key===","||e.key===";"){
    e.preventDefault();
    const names = splitNames(obsInput.value);
    app.observers = [...app.observers, ...names.filter(n=>!app.observers.includes(n))];
    obsInput.value="";
    renderSetup(); save();
  }
});
obsInput.addEventListener("paste",(e)=>{
  const t = e.clipboardData?.getData("text")||"";
  if(/[,\n;]/.test(t)){ e.preventDefault(); const names=splitNames(t);
    app.observers = [...app.observers, ...names.filter(n=>!app.observers.includes(n))];
    renderSetup(); save();
  }
});
grpInput.addEventListener("keydown", (e)=>{
  if(e.key==="Enter"||e.key===","||e.key===";"){
    e.preventDefault();
    const names = splitNames(grpInput.value);
    app.group = [...app.group, ...names.filter(n=>!app.group.includes(n))];
    grpInput.value="";
    renderSetup(); save();
  }
});
grpInput.addEventListener("paste",(e)=>{
  const t = e.clipboardData?.getData("text")||"";
  if(/[,\n;]/.test(t)){ e.preventDefault(); const names=splitNames(t);
    app.group = [...app.group, ...names.filter(n=>!app.group.includes(n))];
    renderSetup(); save();
  }
});

// counts binding
Object.keys(countInputs).forEach(k=>{
  countInputs[k].addEventListener("input",(e)=>{
    const v = Math.max(0, Number(e.target.value)||0);
    app.counts[k] = v;
    save();
  });
});

/** =======================
 *  RENDER
 *  ======================= */
function show(page){
  Object.values(pages).forEach(el=> el.classList.add("hidden"));
  pages[page].classList.remove("hidden");
  modeLabel.textContent = page==="setup"?"Configuration": page==="observe"?"Observation" : page==="evals"?"√âvaluations":"Accueil";
}

function renderSetup(){
  toChips(obsChips, app.observers, (i)=>{ app.observers.splice(i,1); renderSetup(); save(); });
  toChips(grpChips, app.group, (i)=>{ app.group.splice(i,1); renderSetup(); save(); });
  countInputs.p2.value = app.counts.p2;
  countInputs.p3.value = app.counts.p3;
  countInputs.p4.value = app.counts.p4;
  countInputs.p5.value = app.counts.p5;
  countInputs.libre.value = app.counts.libre;
  compoCount.textContent = app.evals.length;
}

function renderObserve(){
  // boutons compositions
  compoButtons.innerHTML = "";
  app.evals.forEach((ev, idx)=>{
    const cnt = { p2:0,p3:0,p4:0,p5:0,libre:0 };
    ev.pyramides.forEach(p=>{ cnt[p.type]++; });
    const b = document.createElement("button");
    b.className = "btn " + (app.selectedId===ev.id? "btn-primary":"btn-secondary");
    b.textContent = `${idx+1}. P2:${cnt.p2} P3:${cnt.p3} P4:${cnt.p4} P5:${cnt.p5} L:${cnt.libre}`;
    b.onclick = ()=>{ app.selectedId = ev.id; renderObserve(); save(); };
    compoButtons.appendChild(b);
  });
  badgeTotal.textContent = app.evals.length;
  observeContent.innerHTML = "";

  const ev = app.evals.find(e=>e.id===app.selectedId);
  if(!ev){
    observeContent.innerHTML = `<div class="muted">Ajoute une composition puis s√©lectionne-la.</div>`;
    return;
  }

  // bloc groupe (edit)
  const cardGrp = document.createElement("div");
  cardGrp.className = "card";
  cardGrp.innerHTML = `
    <div class="title">üë• Groupe (appliqu√© √† l'√©valuation individuelle)</div>
    <input type="text" id="grpEdit" placeholder="ex. In√®s, L√©o" />
    <div class="chips" id="grpEditChips"></div>
  `;
  observeContent.appendChild(cardGrp);

  const grpEdit = cardGrp.querySelector("#grpEdit");
  const grpEditChips = cardGrp.querySelector("#grpEditChips");
  toChips(grpEditChips, ev.groupeList||[], (i)=>{
    ev.groupeList.splice(i,1);
    ev.eleves = syncEleves(ev.eleves, ev.groupeList);
    renderObserve(); save();
  });
  grpEdit.addEventListener("keydown", (e)=>{
    if(e.key==="Enter"||e.key===","||e.key===";"){
      e.preventDefault();
      const names = splitNames(grpEdit.value);
      ev.groupeList = [...(ev.groupeList||[]), ...names.filter(n=>!(ev.groupeList||[]).includes(n))];
      ev.eleves = syncEleves(ev.eleves, ev.groupeList);
      grpEdit.value = "";
      renderObserve(); save();
    }
  });
  grpEdit.addEventListener("paste", (e)=>{
    const t = e.clipboardData?.getData("text")||"";
    if(/[,\n;]/.test(t)){ e.preventDefault(); const names=splitNames(t);
      ev.groupeList = [...(ev.groupeList||[]), ...names.filter(n=>!(ev.groupeList||[]).includes(n))];
      ev.eleves = syncEleves(ev.eleves, ev.groupeList);
      renderObserve(); save();
    }
  });

  // liste des pyramides
  const wrap = document.createElement("div");
  wrap.className = "grid grid-2";
  ev.pyramides.forEach((p, idx)=>{
    const el = document.createElement("div");
    el.className = `pyr ${COLORS[p.type]}`;
    el.innerHTML = `
      <div class="bar"><div class="title">#${idx+1} ‚Äî ${LABEL[p.type]}</div><div class="muted">${NEED[p.type] ? NEED[p.type]+ " √©l√®ves" : "libre"}</div></div>
      <div class="seg">
        <div class="title" style="font-size:14px">‚è±Ô∏è Tenue 3s</div>
        <div class="row">
          <button class="btn ${p.tenue==='oui'?'btn-primary':'btn-secondary'}" data-tn="oui">OUI</button>
          <button class="btn ${p.tenue==='non'?'btn-danger':'btn-secondary'}" data-tn="non">NON</button>
        </div>
      </div>
      <div class="seg">
        <div class="title" style="font-size:14px">üîí S√©curit√©</div>
        <div class="grid">
          ${DEFAULT_SECURITE.map((crit,i)=>`
            <div class="card" style="padding:8px">
              <div class="muted" style="margin-bottom:6px">${crit}</div>
              <div class="fmblist row">
                <button data-fmb="fragile" class="${p.securite[crit]==='fragile'?'active':''}">üî¥ Fragile</button>
                <button data-fmb="moyen" class="${p.securite[crit]==='moyen'?'active':''}">üü° Moyen</button>
                <button data-fmb="bon" class="${p.securite[crit]==='bon'?'active':''}">üü¢ Bon</button>
              </div>
            </div>
          `).join("")}
        </div>
      </div>
    `;
    // bind tenue
    el.querySelectorAll("[data-tn]").forEach(b=>{
      b.addEventListener("click", ()=>{
        p.tenue = b.getAttribute("data-tn");
        renderObserve(); save();
      });
    });
    // bind fmb
    el.querySelectorAll(".fmblist").forEach((rowEl, i)=>{
      rowEl.querySelectorAll("[data-fmb]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const val = btn.getAttribute("data-fmb");
          const crit = DEFAULT_SECURITE[i];
          p.securite[crit] = val;
          renderObserve(); save();
        });
      });
    });

    wrap.appendChild(el);
  });
  observeContent.appendChild(wrap);
}

function renderEvals(){
  const ev = app.evals.find(e=>e.id===app.selectedId);
  if(!ev){ return; }

  // sliders ensemble
  ensembleSliders.innerHTML = "";
  [
    ["composition","Composition"],
    ["entree","Entr√©e"],
    ["sortie","Sortie"],
    ["originalite","Originalit√©"],
  ].forEach(([key,label])=>{
    const row = document.createElement("div");
    row.className = "card";
    row.innerHTML = `
      <div class="bar"><div class="muted">${label}</div>
        <div class="row">
          <button class="btn btn-secondary" data-minus="${key}">‚àí</button>
          <button class="btn btn-secondary" data-plus="${key}">+</button>
        </div>
      </div>
      <div class="rangeRow" style="margin-top:8px">
        <input type="range" min="0" max="5" step="1" value="${ev[key]||0}" data-range="${key}" />
        <div class="pill">${ev[key]||0}/5</div>
      </div>
    `;
    row.querySelector(`[data-minus="${key}"]`).onclick = ()=>{ ev[key] = Math.max(0,(ev[key]||0)-1); renderEvals(); save(); };
    row.querySelector(`[data-plus="${key}"]`).onclick = ()=>{ ev[key] = Math.min(5,(ev[key]||0)+1); renderEvals(); save(); };
    row.querySelector(`[data-range="${key}"]`).oninput = (e)=>{ ev[key] = Number(e.target.value); renderEvals(); save(); };
    ensembleSliders.appendChild(row);
  });

  // commentaire + note
  commentaire.value = ev.commentaire||"";
  commentaire.oninput = (e)=>{ ev.commentaire = e.target.value; save(); };
  noteFinale.value = ev.noteFinale||0;
  noteFinale.oninput = (e)=>{ ev.noteFinale = Number(e.target.value)||0; save(); };

  // individuel
  elevesList.innerHTML = "";
  (ev.eleves||[]).forEach((el, idx)=>{
    const line = document.createElement("div");
    line.className = "card";
    line.innerHTML = `
      <div class="bar"><div class="title" style="font-size:14px">${el.name}</div></div>
      <div class="row" style="margin-top:6px">
        <div style="flex:0 0 140px">
          <label class="muted">Note /20</label>
          <input type="number" min="0" max="20" value="${el.note||0}" data-note="${idx}" />
        </div>
        <div style="flex:1">
          <label class="muted">Avis</label>
          <textarea data-avis="${idx}">${el.avis||""}</textarea>
        </div>
      </div>
    `;
    line.querySelector(`[data-note="${idx}"]`).oninput = (e)=>{ el.note = Number(e.target.value)||0; save(); };
    line.querySelector(`[data-avis="${idx}"]`).oninput = (e)=>{ el.avis = e.target.value; save(); };
    elevesList.appendChild(line);
  });
}

/** =======================
 *  ACTIONS
 *  ======================= */
function addComposition(goToObserve){
  const list = [
    ...Array.from({length: app.counts.p2}, ()=>"p2"),
    ...Array.from({length: app.counts.p3}, ()=>"p3"),
    ...Array.from({length: app.counts.p4}, ()=>"p4"),
    ...Array.from({length: app.counts.p5}, ()=>"p5"),
    ...Array.from({length: app.counts.libre}, ()=>"libre"),
  ];
  const pyramides = list.map(makePyramide);
  const ev = {
    id: uid(),
    date: new Date().toISOString(),
    observerList: [...app.observers],
    groupeList: [...app.group],
    pyramides,
    composition: 0, entree: 0, sortie: 0, originalite: 0,
    noteFinale: 0, commentaire: "",
    eleves: syncEleves([], app.group),
  };
  app.evals.unshift(ev);
  app.selectedId = ev.id;
  renderSetup(); renderObserve(); save();
  if(goToObserve) show("observe");
}

/** =======================
 *  EXPORTS
 *  ======================= */
function exportJSON(){
  const blob = new Blob([ JSON.stringify(app, null, 2) ], { type:"application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = `acrojuge_${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a); a.click(); setTimeout(()=>{ a.remove(); URL.revokeObjectURL(url); }, 0);
}

function exportCSV(){
  const securitePoints = DEFAULT_SECURITE;
  const headers = [
    "index","date","observateurs","groupe",
    "p2","p3","p4","p5","libre","total_pyramides",
    "composition","entree","sortie","originalite","noteFinale",
    ...securitePoints.map(s=>`SECURITE:${s} (F/M/B)`),
    "eleves:noms","eleves:notes","eleves:avis",
  ];
  const rows = (app.evals||[]).map((e,idx)=>{
    const counts = { p2:0,p3:0,p4:0,p5:0,libre:0 };
    const secAgg = Object.fromEntries(securitePoints.map(s=>[s,{fragile:0,moyen:0,bon:0}]));
    (e.pyramides||[]).forEach(p=>{
      counts[p.type]++; securitePoints.forEach(s=>{ secAgg[s][p.securite[s]]++; });
    });
    const n = (e.eleves||[]).map(el=>el.name).join("|");
    const notes = (e.eleves||[]).map(el=>el.note||0).join("|");
    const avis = (e.eleves||[]).map(el=>(el.avis||"").replace(/[\r\n]+/g," ")).join("|");
    return [
      idx+1,e.date,(e.observerList||[]).join("|"),(e.groupeList||[]).join("|"),
      counts.p2,counts.p3,counts.p4,counts.p5,counts.libre,(e.pyramides||[]).length,
      e.composition,e.entree,e.sortie,e.originalite,e.noteFinale,
      ...securitePoints.map(s=>`${secAgg[s].fragile}/${secAgg[s].moyen}/${secAgg[s].bon}`),
      n,notes,avis
    ];
  });
  const csv = [headers.join(";"), ...rows.map(r=>r.join(";"))].join("\n");
  const blob = new Blob(["\ufeff"+csv], { type:"text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = `acrojuge_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a); a.click(); setTimeout(()=>{ a.remove(); URL.revokeObjectURL(url); }, 0);
}

function exportPDF(){
  if(window.__HAS_LOCAL_JSPDF__ && window.jspdf){
    // Export via jsPDF (local, aucun site externe)
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:"pt", format:"a4" });
    const footer = "AcroJuge - Equipe EPS Lyc√©e Vauban - LUXEMBOURG - JB";
    let y = 40; const maxW = 535;
    const newLine = (dy=16)=>{ y+=dy; if(y>780){ doc.addPage(); y=40; } };

    doc.setFontSize(14);
    doc.text("AcroJuge ‚Äî Observations", 40, y); newLine(24);
    doc.setFontSize(11);

    (app.evals||[]).forEach((e,i)=>{
      const observers = (e.observerList||[]).join(", ") || "(observateurs)";
      const groupe = (e.groupeList||[]).join(", ") || "(groupe)";
      doc.text(`${i+1}. ${groupe} (Obs: ${observers})`, 40, y); newLine();

      if((e.pyramides||[]).length){
        doc.text("Pyramides de l'encha√Ænement:", 40, y); newLine();
        (e.pyramides||[]).forEach((p,idx)=>{
          const sec = Object.entries(p.securite).map(([k,v])=>`${DOT[v]} ${k}`).join(" ‚Ä¢ ");
          doc.splitTextToSize(`${idx+1}. ${LABEL[p.type]} ‚Äî Tenue: ${p.tenue.toUpperCase()} ‚Äî S√©curit√©: ${sec}`, maxW)
             .forEach(ln=>{ doc.text(ln,40,y); newLine(14); });
        });
        newLine(6);
      }

      doc.text(`Ensemble ‚Äî Composition: ${e.composition}/5 | Entr√©e: ${e.entree}/5 | Sortie: ${e.sortie}/5 | Originalit√©: ${e.originalite}/5`,40,y); newLine();
      doc.text(`Note finale /20: ${e.noteFinale}`,40,y); newLine(8);
      if(e.commentaire){
        doc.splitTextToSize(`Commentaire: ${e.commentaire}`, maxW).forEach(ln=>{ doc.text(ln,40,y); newLine(14); });
      }
      newLine(8);

      if((e.eleves||[]).length){
        doc.setFontSize(12); doc.text("√âvaluation individuelle",40,y); newLine(); doc.setFontSize(11);
        (e.eleves||[]).forEach(el=>{
          doc.text(`‚Ä¢ ${el.name} ‚Äî Note: ${el.note||0}/20`,40,y); newLine();
          if(el.avis){ doc.splitTextToSize(`   Avis: ${el.avis}`, maxW).forEach(ln=>{ doc.text(ln,40,y); newLine(14); }); }
        });
        newLine(10);
      }

      if(y>760){ doc.addPage(); y=40; }
    });

    // Pied de page
    const pages = doc.getNumberOfPages();
    for(let i=1;i<=pages;i++){
      doc.setPage(i); doc.setFontSize(9); doc.setTextColor(120);
      doc.text(`${footer}  ‚Ä¢  Page ${i}/${pages}  ‚Ä¢  ${new Date().toLocaleDateString()}`, 40, 820);
      doc.setTextColor(0);
    }
    doc.save(`AcroJuge_${new Date().toISOString().slice(0,10)}.pdf`);
  } else {
    // Fallback imprimante ‚Üí ‚ÄúSave/Share as PDF‚Äù (iPad/MDM OK + AirDrop)
    window.print();
  }
}

/** =======================
 *  INIT
 *  ======================= */
function init(){
  load();
  renderSetup();
  renderObserve();
  renderEvals();
  show("cover");
}
init();
</script>
</body>
</html>
