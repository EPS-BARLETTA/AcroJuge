<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>AcroJuge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f6f8fb;--card:#fff;--text:#111827;--muted:#6b7280;--border:#e5e7eb;
      --p2:#e0f2fe;--p3:#dcfce7;--p4:#fef3c7;--p5:#fae8ff;--libre:#f3f4f6;
      --green:#16a34a;--green-dark:#065f46;--red:#ef4444;--amber:#f59e0b;
      --modal-bg: rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    .app{min-height:100dvh;display:flex;flex-direction:column}
    .header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);padding:8px 16px;display:flex;gap:8px;align-items:center;justify-content:flex-end;z-index:10}
    .btn{border:0;border-radius:12px;padding:10px 16px;cursor:pointer;font-weight:700}
    .btn-green{background:var(--green);color:#fff}
    .btn-green-dark{background:var(--green-dark);color:#fff}
    .btn-blue{background:#2563eb;color:#fff}
    .btn-gray{background:#e5e7eb}
    .btn-red{background:var(--red);color:#fff}
    .btn-amber{background:var(--amber);color:#111}
    .main{flex:1;display:flex;align-items:center;justify-content:center;padding:24px}
    .section{width:min(1100px,95vw)}
    .pageTitle{text-align:center;margin:8px 0 20px}
    .pageTitle h1{font-size:34px;line-height:1.1;margin:0}
    .pageTitle .sub{color:var(--muted);font-size:14px;margin-top:6px}
    .hero{display:grid;place-items:center;height:70vh;text-align:center}
    .hero h1{font-size:56px;line-height:1.05;margin:0 0 8px}
    .hero p{color:var(--muted);font-size:18px;margin:0 0 28px}
    .start{font-size:18px;padding:14px 28px;border-radius:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 320px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:14px}
    .title{font-weight:700;margin-bottom:8px}
    .muted{color:var(--muted);font-size:12px}
    input[type="text"],input[type="number"],textarea{width:100%;border:1px solid var(--border);border-radius:12px;padding:10px;font-size:16px;background:#fff}
    input::placeholder, textarea::placeholder{color:#9ca3af}
    textarea{min-height:84px;resize:vertical}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .chip{background:#f3f4f6;border-radius:999px;padding:6px 10px;font-size:13px;display:inline-flex;gap:8px;align-items:center}
    .chip button{border:0;background:transparent;cursor:pointer;color:#6b7280}
    .grid{display:grid;gap:10px}
    .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .bar{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .pyr{border:1px solid var(--border);border-radius:16px;padding:12px}
    .p2{background:var(--p2)} .p3{background:var(--p3)} .p4{background:var(--p4)} .p5{background:var(--p5)} .libre{background:var(--libre)}
    .seg{border:1px dashed var(--border);padding:8px;border-radius:12px;margin-top:8px;background:#fff}
    .fmblist button{border:0;border-radius:10px;padding:8px 10px;background:#e5e7eb;cursor:pointer}
    .fmblist button.active{outline:2px solid #111;outline-offset:2px;background:#fff}
    .nav{display:flex;justify-content:space-between;gap:10px;margin-top:12px}
    .footer{border-top:1px solid var(--border);background:#fff;padding:10px 16px;text-align:center;color:#6b7280;font-size:12px}
    .hidden{display:none}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:50;padding:16px}
    .modal.show{display:flex}
    .modal-card{width:min(900px,95vw);max-height:85vh;overflow:auto;background:#fff;border-radius:18px;border:1px solid var(--border);padding:16px}
    .modal-title{font-weight:800;font-size:18px;margin:0 0 10px}
    .list-row{display:flex;gap:8px;align-items:center;justify-content:space-between;border:1px solid var(--border);border-radius:12px;padding:10px;background:#fafafa}
    .note-item{display:flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:12px;padding:8px;background:#fff}
    .note-item .who{font-weight:600}
    .note-item input{width:100px}
    @media print{
      .header,.nav,.no-print,.modal{display:none!important}
      body{background:#fff}
      .card{break-inside:avoid}
      .footer{display:block!important;position:fixed;bottom:0;left:0;right:0}
    }
  </style>
  <script>window.__HAS_LOCAL_JSPDF__=false;</script>
  <script src="libs/jspdf.umd.min.js" onload="window.__HAS_LOCAL_JSPDF__=true" defer></script>
</head>
<body>
<div class="app">
  <!-- En-tête : Aide + Reset uniquement -->
  <header class="header">
    <button class="btn btn-amber" id="btnHelp">❓ Aide</button>
    <button class="btn btn-red" id="btnHardReset">♻️ Reset</button>
  </header>

  <main class="main">
    <!-- PAGE 1 : COVER -->
    <section id="page-cover" class="section">
      <div class="hero">
        <div>
          <h1>AcroJuge</h1>
          <p>Observer • Juger • Exporter</p>
          <button class="btn btn-green start" id="goSetup">Commencer</button>
        </div>
      </div>
    </section>

    <!-- PAGE 2 : CONFIG -->
    <section id="page-setup" class="section hidden">
      <div class="pageTitle">
        <h1>Configuration</h1>
        <div class="sub">Observateurs • Groupe • Plan d’enchaînement</div>
      </div>

      <div class="row">
        <div class="col card">
          <div class="title">👀 Observateur·rice(s)</div>
          <input type="text" id="obsInput" placeholder="ex. Ambre, Léo" />
          <div class="chips" id="obsChips"></div>
          <div class="muted">Colle une liste (virgule / point-virgule / retour ligne).</div>
        </div>
        <div class="col card">
          <div class="title">👥 Groupe observé (par défaut)</div>
          <input type="text" id="grpInput" placeholder="ex. Inès, Léo" />
          <div class="chips" id="grpChips"></div>
          <div class="muted">Servira pour l’évaluation individuelle.</div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="bar">
          <div class="title">🗓️ Plan d’enchaînement (prochaine observation)</div>
          <div class="muted">Observations créées : <span id="compoCount">0</span></div>
        </div>
        <div class="grid" style="grid-template-columns:repeat(5,minmax(0,1fr));gap:10px;margin-top:8px">
          <div class="card p2"><label class="muted">Pyramide à 2 ×</label><input type="number" min="0" id="count-p2" value="0"></div>
          <div class="card p3"><label class="muted">Pyramide à 3 ×</label><input type="number" min="0" id="count-p3" value="0"></div>
          <div class="card p4"><label class="muted">Pyramide à 4 ×</label><input type="number" min="0" id="count-p4" value="0"></div>
          <div class="card p5"><label class="muted">Pyramide à 5 ×</label><input type="number" min="0" id="count-p5" value="0"></div>
          <div class="card libre"><label class="muted">Pyramide libre ×</label><input type="number" min="0" id="count-libre" value="0"></div>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn btn-gray" id="btnResetCounts">Réinitialiser</button>
          <button class="btn btn-green" id="btnStartObserve">▶️ Démarrer l’observation</button>
        </div>
      </div>
    </section>

    <!-- PAGE 3 : OBSERVATION -->
    <section id="page-observe" class="section hidden">
      <div class="pageTitle">
        <h1>Observation</h1>
        <div class="sub">Tenue (3s) & Sécurité (🔴/🟡/🟢/🟩) pour chaque pyramide</div>
      </div>

      <div id="observeContent" class="card"></div>

      <div class="nav">
        <button class="btn btn-gray" id="observeBack">⬅️ Configuration</button>
        <button class="btn btn-green" id="observeNext">Évaluations ➡️</button>
      </div>
    </section>

    <!-- PAGE 4 : EVALUATIONS -->
    <section id="page-evals" class="section hidden">
      <div class="pageTitle">
        <h1>Évaluations</h1>
        <div class="sub">Ensemble (🔴/🟡/🟢/🟩) + Individuel /20</div>
      </div>

      <div class="card">
        <div class="title">📝 Évaluation de l’ensemble</div>
        <div id="ensembleFMB" class="grid grid-2" style="margin-top:8px"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="title">👤 Évaluation individuelle (note /20)</div>
        <div id="elevesList" class="grid grid-3"></div>
      </div>

      <div class="row" style="margin-top:12px">
        <div class="col card">
          <div class="title">🗒️ Commentaire global</div>
          <textarea id="commentaire" placeholder="(facultatif)"></textarea>
        </div>
        <div class="col card">
          <div class="title">🏁 Note finale /20</div>
          <input type="number" id="noteFinale" min="0" max="20" step="0.5" placeholder="—" />
          <div class="muted" style="margin-top:6px">Demi-points autorisés.</div>
        </div>
      </div>

      <div class="nav">
        <button class="btn btn-gray" id="evalsBack">⬅️ Observation</button>
        <div class="row">
          <button class="btn btn-blue" id="btnShowList">📂 Enchaînements</button>
          <button class="btn btn-amber" id="btnNewObservation">➕ Nouvelle observation</button>
          <!-- Unique bouton d’export -->
          <button class="btn btn-green-dark" id="btnExportByObservers">📄 Exporter en PDF</button>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">
    AcroJuge - Equipe EPS Lycée Vauban - LUXEMBOURG - JB
  </footer>
</div>

<!-- Modal : AIDE -->
<div class="modal" id="modalHelp">
  <div class="modal-card">
    <div class="bar">
      <h2 class="modal-title">Aide – Comment utiliser AcroJuge</h2>
      <button class="btn btn-gray" id="helpClose">Fermer</button>
    </div>
    <div class="grid">
      <div class="card">
        <div class="title">1) Configuration</div>
        <ul>
          <li>Ajoute les <b>observateurs</b> (séparés par virgule, point-virgule ou retour à la ligne).</li>
          <li>Ajoute le <b>groupe observé</b> (prénoms) : pour l’évaluation individuelle.</li>
          <li>Renseigne le <b>plan d’enchaînement</b> : nombre de pyramides à 2 / 3 / 4 / 5 / libres.</li>
          <li>Appuie sur <b>Démarrer l’observation</b> pour créer l’enchaînement et passer à l’observation.</li>
        </ul>
      </div>
      <div class="card">
        <div class="title">2) Observation</div>
        <ul>
          <li>Pour chaque pyramide : <b>Tenue 3s</b> (OUI/NON) et <b>Sécurité</b> par critère.</li>
          <li>Codes : 🔴 Fragile, 🟡 Moyen, 🟢 Bon, 🟩 Très bon.</li>
        </ul>
      </div>
      <div class="card">
        <div class="title">3) Évaluations</div>
        <ul>
          <li><b>Évaluation de l’ensemble</b> : F/M/B/TB pour Composition, Entrée, Sortie, Originalité.</li>
          <li><b>Évaluation individuelle</b> : notes /20 (demi-points possibles), champs vides par défaut.</li>
          <li><b>Nouvelle observation</b> : remet le <b>groupe</b> et le <b>plan</b> à zéro, retour “Configuration”.</li>
          <li>À la fin, appuie sur <b>📄 Exporter en PDF</b> : un <b>seul document</b> au <b>nom des observateurs</b> avec <b>tous</b> les groupes observés.</li>
        </ul>
      </div>
      <div class="card">
        <div class="title">Conseils iPad</div>
        <ul>
          <li>Ajoute l’app à l’écran d’accueil (Safari ⋯ → <b>Sur l’écran d’accueil</b>).</li>
          <li>Si le PDF ne se télécharge pas, utilise <b>Imprimer</b> → <b>Enregistrer en PDF</b>.</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Modal : LISTE ENCHAINEMENTS -->
<div class="modal" id="modalList">
  <div class="modal-card">
    <div class="bar">
      <h2 class="modal-title">Enchaînements évalués</h2>
      <button class="btn btn-gray" id="listClose">Fermer</button>
    </div>
    <div id="listContainer" class="grid"></div>
  </div>
</div>

<script>
/* ===== PERSISTENCE ===== */
const STORAGE_KEY = "acrojuge_state_ui_v7_single_export";
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(app)); }
function load(){ try{ const raw=localStorage.getItem(STORAGE_KEY); if(raw) Object.assign(app, JSON.parse(raw)); }catch{} }
function hardReset(){
  if(!confirm("Tout réinitialiser ? Cela efface toutes les observations enregistrées.")) return;
  localStorage.removeItem(STORAGE_KEY);
  Object.assign(app, freshApp());
  renderAll(); show("cover"); save();
}

/* ===== APP STATE ===== */
function freshApp(){
  return {
    observers: [],
    group: [],
    counts: {p2:0,p3:0,p4:0,p5:0,libre:0},
    evals: [],              // [{id,date,observerList,groupeList,pyramides[],ensemble:{},noteFinale,commentaire,eleves[]}]
    selectedId: null
  };
}
const app = freshApp();

/* ===== CONSTS ===== */
const LABEL = { p2:"Pyramide à 2", p3:"Pyramide à 3", p4:"Pyramide à 4", p5:"Pyramide à 5", libre:"Pyramide libre" };
const NEED  = { p2:2, p3:3, p4:4, p5:5 };
const COLORS= { p2:"p2", p3:"p3", p4:"p4", p5:"p5", libre:"libre" };
const DEFAULT_SECURITE = [
  "Rôles définis (porteurs / voltige)",
  "Prises sûres et alignements",
  "Montée contrôlée",
  "Tenue sans danger",
  "Descente sécurisée",
];
const ENSEMBLE_CRITS = ["Composition","Entrée","Sortie","Originalité"];
const LEVELS = ["fragile","moyen","bon","tb"];
const DOT = { fragile:"🔴", moyen:"🟡", bon:"🟢", tb:"🟩" };

/* ===== DOM ===== */
const $ = (id)=> document.getElementById(id);
document.addEventListener("DOMContentLoaded", ()=>{
  // Navigation
  $("goSetup").onclick     = ()=> show("setup");
  $("observeBack").onclick = ()=> show("setup");
  $("observeNext").onclick = ()=> show("evals");
  $("evalsBack").onclick   = ()=> show("observe");
  $("btnNewObservation").onclick = newObservationFlow;

  // Modals
  $("btnHelp").onclick     = ()=> toggleModal("modalHelp", true);
  $("helpClose").onclick   = ()=> toggleModal("modalHelp", false);
  $("btnShowList").onclick = ()=> { renderListModal(); toggleModal("modalList", true); };
  $("listClose").onclick   = ()=> toggleModal("modalList", false);

  // Reset
  $("btnHardReset").onclick   = hardReset;
  $("btnResetCounts").onclick = ()=>{ app.counts={p2:0,p3:0,p4:0,p5:0,libre:0}; renderSetup(); save(); };
  $("btnStartObserve").onclick= ()=> addObservation(true);

  // Unique export button (par observateurs)
  $("btnExportByObservers").onclick = exportByObserversPDF;

  // Chips
  const obsInput=$("obsInput"), grpInput=$("grpInput");
  obsInput.addEventListener("keydown",(e)=>{ if(["Enter",",",";"].includes(e.key)){ e.preventDefault(); addNames("observers", obsInput.value); obsInput.value=""; }});
  obsInput.addEventListener("paste",(e)=>{ const t=e.clipboardData?.getData("text")||""; if(/[,\n;]/.test(t)){ e.preventDefault(); addNames("observers", t); }});
  grpInput.addEventListener("keydown",(e)=>{ if(["Enter",",",";"].includes(e.key)){ e.preventDefault(); addNames("group", grpInput.value); grpInput.value=""; }});
  grpInput.addEventListener("paste",(e)=>{ const t=e.clipboardData?.getData("text")||""; if(/[,\n;]/.test(t)){ e.preventDefault(); addNames("group", t); }});

  // Counters
  ["p2","p3","p4","p5","libre"].forEach(k=>{
    $("count-"+k).addEventListener("input",(e)=>{ app.counts[k] = Math.max(0, Number(e.target.value)||0); save(); });
  });

  load(); renderAll(); show("cover");
});

function show(which){
  ["page-cover","page-setup","page-observe","page-evals"].forEach(id=>$(id).classList.add("hidden"));
  const map={cover:"page-cover",setup:"page-setup",observe:"page-observe",evals:"page-evals"};
  $(map[which]).classList.remove("hidden");
}
function toggleModal(id,open){ $(id).classList.toggle("show", !!open); }

/* ===== HELPERS ===== */
function uid(){ return Math.random().toString(36).slice(2,10); }
function toChips(container, arr, onRemove){
  container.innerHTML = "";
  (arr||[]).forEach((name, i)=>{
    const s = document.createElement("span");
    s.className = "chip";
    s.innerHTML = `<span>${name}</span>`;
    const b = document.createElement("button");
    b.textContent = "×";
    b.onclick = ()=>{ onRemove(i); };
    s.appendChild(b);
    container.appendChild(s);
  });
}
function splitNames(text){ return text.replace(/\r\n?/g,"\n").split(/[ ,;\n]+/).map(s=>s.trim()).filter(Boolean); }
function addNames(field, raw){
  const names = splitNames(raw);
  if(field==="observers"){ app.observers = [...app.observers, ...names.filter(n=>!app.observers.includes(n))]; }
  else { app.group = [...app.group, ...names.filter(n=>!app.group.includes(n))]; }
  renderSetup(); save();
}
function syncEleves(prev, names){ const by=new Map((prev||[]).map(e=>[e.name,e])); return (names||[]).map(n=> by.get(n) || { name:n, note:null }); }
function makePyramide(t){ const sec=Object.fromEntries(DEFAULT_SECURITE.map(s=>[s,"moyen"])); return { id:uid(), type:t, securite:sec, tenue:"non" }; }
function slugifyNames(arr){ return (arr||[]).map(n=>n.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z0-9]+/g,"_").replace(/^_|_$/g,"")).filter(Boolean).join("_")||"Observateurs"; }
function normalizeName(s=""){ return s.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim().replace(/\s+/g," "); }
function arraysEqualIgnoreOrderNormalized(a=[], b=[]){
  const A=(a||[]).map(normalizeName).filter(Boolean).sort();
  const B=(b||[]).map(normalizeName).filter(Boolean).sort();
  if (A.length !== B.length) return false;
  for (let i=0;i<A.length;i++) if (A[i] !== B[i]) return false;
  return true;
}

/* ===== RENDER ===== */
function renderAll(){ renderSetup(); renderObserve(); renderEvals(); }

function renderSetup(){
  toChips($("obsChips"), app.observers, (i)=>{ app.observers.splice(i,1); renderSetup(); save(); });
  toChips($("grpChips"), app.group, (i)=>{ app.group.splice(i,1); renderSetup(); save(); });
  $("compoCount").textContent = app.evals.length;
  ["p2","p3","p4","p5","libre"].forEach(k=>{ $("count-"+k).value = app.counts[k]; });
}

function renderObserve(){
  const observeContent=$("observeContent");
  observeContent.innerHTML = "";
  const ev = app.evals.find(e=>e.id===app.selectedId);
  if(!ev){ observeContent.innerHTML = `<div class="muted">Démarre une observation pour créer le premier enchaînement.</div>`; return; }

  // Groupe éditable
  const grpCard=document.createElement("div");
  grpCard.className="card";
  grpCard.innerHTML = `
    <div class="title">👥 Groupe de l’observation</div>
    <input type="text" id="grpEdit" placeholder="ex. Inès, Léo" />
    <div class="chips" id="grpEditChips"></div>
  `;
  observeContent.appendChild(grpCard);
  const grpEdit=grpCard.querySelector("#grpEdit");
  const grpEditChips=grpCard.querySelector("#grpEditChips");
  toChips(grpEditChips, ev.groupeList||[], (i)=>{ ev.groupeList.splice(i,1); ev.eleves=syncEleves(ev.eleves, ev.groupeList); renderObserve(); save(); });
  grpEdit.addEventListener("keydown",(e)=>{ if(["Enter",",",";"].includes(e.key)){ e.preventDefault(); const names=splitNames(grpEdit.value); ev.groupeList=[...(ev.groupeList||[]), ...names.filter(n=>!(ev.groupeList||[]).includes(n))]; ev.eleves=syncEleves(ev.eleves, ev.groupeList); grpEdit.value=""; renderObserve(); save(); }});
  grpEdit.addEventListener("paste",(e)=>{ const t=e.clipboardData?.getData("text")||""; if(/[,\n;]/.test(t)){ e.preventDefault(); const names=splitNames(t); ev.groupeList=[...(ev.groupeList||[]), ...names.filter(n=>!(ev.groupeList||[]).includes(n))]; ev.eleves=syncEleves(ev.eleves, ev.groupeList); renderObserve(); save(); }});

  // Pyramides
  const wrap=document.createElement("div"); wrap.className="grid grid-2";
  ev.pyramides.forEach((p, idx)=>{
    const el=document.createElement("div"); el.className=`pyr ${COLORS[p.type]}`;
    el.innerHTML = `
      <div class="bar"><div class="title">#${idx+1} — ${LABEL[p.type]}</div><div class="muted">${NEED[p.type]? NEED[p.type]+" élèves":"libre"}</div></div>
      <div class="seg">
        <div class="title" style="font-size:14px">⏱️ Tenue 3s</div>
        <div class="row">
          <button class="btn ${p.tenue==='oui'?'btn-green':'btn-gray'}" data-tn="oui">OUI</button>
          <button class="btn ${p.tenue==='non'?'btn-red':'btn-gray'}" data-tn="non">NON</button>
        </div>
      </div>
      <div class="seg">
        <div class="title" style="font-size:14px">🔒 Sécurité</div>
        <div class="grid">
          ${DEFAULT_SECURITE.map((crit)=>`
            <div class="card" style="padding:8px">
              <div class="muted" style="margin-bottom:6px">${crit}</div>
              <div class="fmblist row">
                <button data-fmb="fragile" class="${p.securite[crit]==='fragile'?'active':''}">🔴 Fragile</button>
                <button data-fmb="moyen"   class="${p.securite[crit]==='moyen'  ?'active':''}">🟡 Moyen</button>
                <button data-fmb="bon"     class="${p.securite[crit]==='bon'    ?'active':''}">🟢 Bon</button>
                <button data-fmb="tb"      class="${p.securite[crit]==='tb'     ?'active':''}">🟩 Très bon</button>
              </div>
            </div>
          `).join("")}
        </div>
      </div>`;
    // Tenue
    el.querySelectorAll("[data-tn]").forEach(btn=>{
      btn.onclick = ()=>{ p.tenue = btn.getAttribute("data-tn"); renderObserve(); save(); };
    });
    // Sécurité F/M/B/TB
    el.querySelectorAll(".fmblist").forEach((rowEl,i)=>{
      rowEl.querySelectorAll("[data-fmb]").forEach(b=>{
        b.onclick = ()=>{
          const val=b.getAttribute("data-fmb"); const crit=DEFAULT_SECURITE[i];
          p.securite[crit]=val; renderObserve(); save();
        };
      });
    });
    wrap.appendChild(el);
  });
  observeContent.appendChild(wrap);
}

function renderEvals(){
  const ev = app.evals.find(e=>e.id===app.selectedId); if(!ev) return;

  // Ensemble (F/M/B/TB)
  const cont=$("ensembleFMB");
  cont.innerHTML="";
  if(!ev.ensemble) ev.ensemble = Object.fromEntries(ENSEMBLE_CRITS.map(c=>[c,"moyen"]));
  ENSEMBLE_CRITS.forEach((crit)=>{
    const card = document.createElement("div"); card.className="card";
    card.innerHTML = `
      <div class="title" style="font-size:14px">${crit}</div>
      <div class="fmblist row">
        <button data-fmb="fragile" class="${ev.ensemble[crit]==='fragile'?'active':''}">🔴 Fragile</button>
        <button data-fmb="moyen"   class="${ev.ensemble[crit]==='moyen'  ?'active':''}">🟡 Moyen</button>
        <button data-fmb="bon"     class="${ev.ensemble[crit]==='bon'    ?'active':''}">🟢 Bon</button>
        <button data-fmb="tb"      class="${ev.ensemble[crit]==='tb'     ?'active':''}">🟩 Très bon</button>
      </div>`;
    card.querySelectorAll("[data-fmb]").forEach(b=>{
      b.onclick = ()=>{ ev.ensemble[crit] = b.getAttribute("data-fmb"); renderEvals(); save(); };
    });
    cont.appendChild(card);
  });

  // Individuel (3 par ligne, pas de valeur par défaut)
  const elevesList=$("elevesList");
  elevesList.innerHTML="";
  (ev.eleves||[]).forEach((el, idx)=>{
    const item=document.createElement("div"); item.className="note-item";
    item.innerHTML = `
      <div class="who">${el.name}</div>
      <input type="number" min="0" max="20" step="0.5" placeholder="—" value="${el.note ?? ''}" data-note="${idx}" />
    `;
    item.querySelector(`[data-note="${idx}"]`).oninput = (e)=>{ const v=e.target.value; el.note = v===''? null : clamp20(round05(Number(v)||0)); save(); };
    elevesList.appendChild(item);
  });

  // Commentaire / note finale
  const commentaire=$("commentaire"), noteFinale=$("noteFinale");
  commentaire.value = ev.commentaire??"";
  commentaire.oninput = (e)=>{ ev.commentaire=e.target.value; save(); };
  noteFinale.value = ev.noteFinale ?? "";
  noteFinale.oninput = (e)=>{ const v=e.target.value; ev.noteFinale = v===''? null : clamp20(round05(Number(v)||0)); save(); };
}

/* ===== LIST MODAL ===== */
function renderListModal(){
  const cont = $("listContainer");
  cont.innerHTML = "";
  if(!app.evals.length){
    cont.innerHTML = `<div class="muted">Aucun enchaînement pour le moment.</div>`;
    return;
  }
  app.evals.forEach((ev, idx)=>{
    const cnt = { p2:0,p3:0,p4:0,p5:0,libre:0 };
    (ev.pyramides||[]).forEach(p=> cnt[p.type]++);
    const row = document.createElement("div");
    row.className = "list-row";
    row.innerHTML = `
      <div>
        <div><b>${idx+1}.</b> Groupe: ${(ev.groupeList||[]).join(", ")||"(à compléter)"} </div>
        <div class="muted">P2:${cnt.p2} P3:${cnt.p3} P4:${cnt.p4} P5:${cnt.p5} L:${cnt.libre}</div>
      </div>
      <div class="row">
        <button class="btn btn-blue" data-open="${ev.id}">Ouvrir</button>
      </div>
    `;
    row.querySelector(`[data-open="${ev.id}"]`).onclick = ()=>{
      app.selectedId = ev.id;
      toggleModal("modalList", false);
      renderObserve(); renderEvals(); save();
    };
    cont.appendChild(row);
  });
}

/* ===== ACTIONS ===== */
function round05(n){ return Math.round(n*2)/2; }
function clamp20(n){ return Math.min(20, Math.max(0, n)); }

function addObservation(goToObserve){
  const list = [
    ...Array.from({length:app.counts.p2},()=> "p2"),
    ...Array.from({length:app.counts.p3},()=> "p3"),
    ...Array.from({length:app.counts.p4},()=> "p4"),
    ...Array.from({length:app.counts.p5},()=> "p5"),
    ...Array.from({length:app.counts.libre},()=> "libre"),
  ];
  const pyramides = list.map(makePyramide);
  const ev = {
    id:uid(), date:new Date().toISOString(),
    observerList:[...app.observers], groupeList:[...app.group],
    pyramides,
    ensemble: Object.fromEntries(ENSEMBLE_CRITS.map(c=>[c,"moyen"])),
    noteFinale: null, commentaire:"",
    eleves: syncEleves([], app.group),
  };
  app.evals.unshift(ev);
  app.selectedId = ev.id;
  renderSetup(); renderObserve(); renderEvals(); save();
  if(goToObserve) show("observe");
}

function newObservationFlow(){
  app.group = [];
  app.counts = {p2:0,p3:0,p4:0,p5:0,libre:0};
  renderSetup(); save();
  show("setup");
}

/* ===== EXPORT UNIQUE – PAR OBSERVATEURS ===== */
function exportByObserversPDF(){
  const team = (app.observers || []).filter(Boolean);
  if(!team.length){ alert("Renseigne d’abord les observateurs (page Configuration)."); return; }
  renderPDF({ mode:"byObservers", team });
}

function renderPDF({mode, team=[]}){
  const footer = "AcroJuge - Equipe EPS Lycée Vauban - LUXEMBOURG - JB";
  if(!(window.__HAS_LOCAL_JSPDF__ && window.jspdf)){ window.print(); return; }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:"pt",format:"a4"});
  let y=60; const left=40, right=555, maxW=right-left;
  const ensure=(space)=>{ if(y+space>780){ addFooter(); doc.addPage(); y=60; } };
  const nl=(dy=16)=>{ y+=dy; if(y>780){ addFooter(); doc.addPage(); y=60; } };
  const addFooter=()=>{ const p=doc.getCurrentPageInfo().pageNumber;
    doc.setFontSize(9); doc.setTextColor(120);
    doc.text(`${footer}  •  Page ${p}/${doc.getNumberOfPages()}  •  ${new Date().toLocaleDateString()}`, left, 820);
    doc.setTextColor(0);
  };
  const dot = { fragile:"🔴", moyen:"🟡", bon:"🟢", tb:"🟩" };
  const levelText = (lv)=> ({fragile:"Fragile",moyen:"Moyen",bon:"Bon",tb:"Très bon"})[lv]||lv;

  // Sélection des observations : uniquement cette équipe (robuste aux accents/ordre/majuscules)
  let selection = (app.evals || []);
  let headerTitle = "Dossier d’observation — Observateurs: " + (team.join(", ") || "Observateurs");
  let fileName    = `AcroJuge_${slugifyNames(team)}_${new Date().toISOString().slice(0,10)}.pdf`;

  const teamNorm = (team || []).map(normalizeName).filter(Boolean);
  selection = selection.filter(e=>{
    const list = (e.observerList || []).filter(Boolean);
    if (list.length === 0) return arraysEqualIgnoreOrderNormalized(teamNorm, (app.observers || []));
    return arraysEqualIgnoreOrderNormalized(teamNorm, list);
  });

  if(!selection.length){
    alert("Aucune observation trouvée pour cette équipe d’observateurs.\nVérifie les noms saisis (page Configuration).");
    return;
  }

  // En-tête
  doc.setFontSize(20); doc.text(headerTitle, left, y); nl(20);
  doc.setFontSize(11);
  doc.text(`Date d’export : ${new Date().toLocaleDateString()}`, left, y); nl();

  // Corps
  selection.forEach((e, i)=>{
    ensure(60);
    doc.setFont(undefined,"bold");
    doc.text(`${i+1}. Groupe observé: ${(e.groupeList||[]).join(", ") || "(à compléter)"}`, left, y); nl();
    doc.setFont(undefined,"normal");
    const obsLine = (e.observerList||[]).join(", ");
    if(obsLine) { doc.text(`Observateurs (fiche): ${obsLine}`, left, y); nl(6); }

    // Pyramides détaillées
    if((e.pyramides||[]).length){
      doc.setFont(undefined,"bold"); doc.text("Pyramides de l'enchaînement", left, y); nl(10); doc.setFont(undefined,"normal");
      e.pyramides.forEach((p, idx)=>{
        ensure(40);
        doc.setFont(undefined,"bold");
        doc.text(`${idx+1}. ${LABEL[p.type]} — Tenue 3s: ${p.tenue.toUpperCase()}`, left, y); nl();
        doc.setFont(undefined,"normal");
        const lines = Object.entries(p.securite).map(([k,v])=>`   ${dot[v]} ${k} — ${levelText(v)}`);
        lines.forEach(ln=>{
          const wrapped = doc.splitTextToSize(ln, maxW);
          wrapped.forEach(w=>{ ensure(18); doc.text(w, left, y); nl(14); });
        });
        nl(2);
      });
    } else {
      doc.text("(Aucune pyramide)", left, y); nl();
    }

    // Évaluation d’ensemble
    ensure(40);
    doc.setFont(undefined,"bold"); doc.text("Évaluation d’ensemble", left, y); nl();
    doc.setFont(undefined,"normal");
    ENSEMBLE_CRITS.forEach(c=>{
      const lv = (e.ensemble||{})[c] || "moyen";
      ensure(18); doc.text(`• ${c}: ${dot[lv]} ${levelText(lv)}`, left, y); nl();
    });
    nl(4);

    // Note finale + commentaire
    ensure(18);
    const finalTxt = e.noteFinale==null ? "—" : String(Number(e.noteFinale).toFixed(1)).replace(".",",");
    doc.text(`Note finale /20: ${finalTxt}`, left, y); nl();
    if(e.commentaire){
      const wrapped = doc.splitTextToSize(`Commentaire: ${e.commentaire}`, maxW);
      wrapped.forEach(w=>{ ensure(18); doc.text(w, left, y); nl(14); });
    }
    nl(4);

    // Individuel (3 colonnes compactes)
    if((e.eleves||[]).length){
      ensure(24);
      doc.setFont(undefined,"bold"); doc.text("Évaluation individuelle (notes /20)", left, y); nl();
      doc.setFont(undefined,"normal");
      const perRow = 3;
      let xCols = [left, left + (maxW/3), left + 2*(maxW/3)];
      (e.eleves||[]).forEach((el, idx2)=>{
        const col = idx2 % perRow;
        if(col===0 && idx2>0){ nl(16); ensure(18); }
        const n = el.note==null ? "—" : String(Number(el.note).toFixed(1)).replace(".",",");
        doc.text(`${el.name}: ${n}/20`, xCols[col]+4, y);
      });
      nl(18);
    }

    // Séparateur
    ensure(12);
    doc.setDrawColor(220); doc.line(left, y, right, y); doc.setDrawColor(0); nl(12);
  });

  // Pieds de page
  const total = doc.getNumberOfPages();
  for(let i=1;i<=total;i++){
    doc.setPage(i); doc.setFontSize(9); doc.setTextColor(120);
    doc.text(`${footer}  •  Page ${i}/${total}  •  ${new Date().toLocaleDateString()}`, left, 820);
    doc.setTextColor(0);
  }
  doc.save(fileName);
}
</script>
</body>
</html>
