<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>AcroJuge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f6f8fb;--card:#fff;--text:#0f172a;--muted:#6b7280;--border:#e5e7eb;
      --p2:#e0f2fe;--p3:#dcfce7;--p4:#fef3c7;--p5:#fae8ff;--libre:#f3f4f6;
      --green:#16a34a;--green-dark:#065f46;--red:#ef4444;--amber:#f59e0b;--blue:#2563eb;
      --shadow:0 2px 12px rgba(15,23,42,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    .app{min-height:100dvh;display:flex;flex-direction:column}
    .header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);padding:10px 16px;display:flex;gap:8px;align-items:center;justify-content:flex-end;z-index:10;box-shadow:var(--shadow)}
    .btn{border:0;border-radius:12px;padding:10px 16px;cursor:pointer;font-weight:700;letter-spacing:.2px;box-shadow:var(--shadow)}
    .btn-green{background:var(--green);color:#fff}
    .btn-green-dark{background:var(--green-dark);color:#fff}
    .btn-blue{background:var(--blue);color:#fff}
    .btn-gray{background:#e5e7eb}
    .btn-red{background:var(--red);color:#fff}
    .btn-amber{background:var(--amber);color:#111}
    .main{flex:1;display:flex;align-items:center;justify-content:center;padding:24px}
    .section{width:min(1100px,95vw)}
    .pageTitle{text-align:center;margin:8px 0 20px}
    .pageTitle h1{font-size:34px;line-height:1.1;margin:0}
    .pageTitle .sub{color:var(--muted);font-size:14px;margin-top:6px}
    .hero{display:grid;place-items:center;height:70vh;text-align:center}
    .hero h1{font-size:56px;line-height:1.05;margin:0 0 8px}
    .hero p{color:var(--muted);font-size:18px;margin:0 0 28px}
    .start{font-size:18px;padding:14px 28px;border-radius:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 320px}
    .card{background:#fff;border:1px solid var(--border);border-radius:18px;padding:14px;box-shadow:var(--shadow)}
    .title{font-weight:800;margin-bottom:8px}
    .muted{color:var(--muted);font-size:12px}
    input[type="text"],input[type="number"],textarea{width:100%;border:1px solid var(--border);border-radius:12px;padding:10px;font-size:16px;background:#fff}
    input::placeholder, textarea::placeholder{color:#9ca3af}
    textarea{min-height:84px;resize:vertical}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .chip{background:#eef2ff;color:#3730a3;border:1px solid #e0e7ff;border-radius:999px;padding:6px 10px;font-size:13px;display:inline-flex;gap:8px;align-items:center}
    .chip button{border:0;background:transparent;cursor:pointer;color:#6b7280}
    .grid{display:grid;gap:10px}
    .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .bar{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .pyr{border:1px solid var(--border);border-radius:16px;padding:12px}
    .p2{background:var(--p2)} .p3{background:var(--p3)} .p4{background:var(--p4)} .p5{background:var(--p5)} .libre{background:var(--libre)}
    .seg{border:1px dashed var(--border);padding:8px;border-radius:12px;margin-top:8px;background:#fff}
    .fmblist button{border:0;border-radius:10px;padding:8px 10px;background:#e5e7eb;cursor:pointer}
    .fmblist button.active{outline:2px solid #111;outline-offset:2px;background:#fff}
    .nav{display:flex;justify-content:space-between;gap:10px;margin-top:12px}
    .footer{border-top:1px solid var(--border);background:#fff;padding:10px 16px;text-align:center;color:#6b7280;font-size:12px}
    .hidden{display:none}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:50;padding:16px}
    .modal.show{display:flex}
    .modal-card{width:min(900px,95vw);max-height:85vh;overflow:auto;background:#fff;border-radius:18px;border:1px solid var(--border);padding:16px;box-shadow:var(--shadow)}
    .modal-title{font-weight:800;font-size:18px;margin:0 0 10px}
    .list-row{display:flex;gap:8px;align-items:center;justify-content:space-between;border:1px solid var(--border);border-radius:12px;padding:10px;background:#fafafa}
    .note-item{display:flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:12px;padding:8px;background:#fff}
    .note-item .who{font-weight:600}
    .note-item input{width:100px}

    /* ============ PAGE BILAN (imprimable + export PDF) ============ */
    .print-page{
      background:#fff;border:1px solid var(--border);box-shadow:var(--shadow);
      padding:20px;border-radius:18px;
      -webkit-print-color-adjust: exact; print-color-adjust: exact; color-adjust: exact;
    }
    .print-header{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:10px}
    .print-title{font-size:22px;font-weight:900;letter-spacing:.3px}
    .print-sub{color:var(--muted);font-size:12px}
    .print-section{
      background:#f8fafc;border:1px solid var(--border);border-radius:14px;padding:10px 12px;margin:14px 0 10px 0;
      font-weight:800;color:#0f172a
    }
    .print-card{border:1px solid var(--border);border-radius:14px;padding:12px;margin-bottom:12px;background:#fff}
    .avoid-break{break-inside:avoid;page-break-inside:avoid}
    .group-start{break-before:page;page-break-before:always}
    .dot{display:inline-block;width:10px;height:10px;border-radius:999px;margin-right:8px;vertical-align:baseline}
    .dot.red{background:#ef4444}.dot.amber{background:#f59e0b}.dot.green{background:#22c55e}.dot.teal{background:#10b981}

    /* ============ COUVERTURE PDF (offscreen, visuel appli) ============ */
    .cover-root{
      width:794px; height:1123px; /* A4 @96dpi approx pour html2canvas */
      display:flex; align-items:center; justify-content:center; flex-direction:column;
      background:linear-gradient(135deg,#ffffff 0%, #f6f8fb 100%);
      color:#0f172a; border:1px solid var(--border); border-radius:18px;
      -webkit-print-color-adjust: exact; print-color-adjust: exact;
      padding:48px; box-shadow:var(--shadow); position:fixed; left:-99999px;
    }
    .cover-badge{
      display:inline-block; padding:6px 12px; border-radius:999px; font-weight:800;
      background:#eef2ff; color:#3730a3; border:1px solid #e0e7ff; letter-spacing:.3px; margin-bottom:16px
    }
    /* â€” tailles augmentÃ©es ici â€” */
    .cover-title{ font-size:54px; font-weight:900; text-align:center; line-height:1.12; margin:0 0 14px 0}
    .cover-names{ font-size:32px; text-align:center; opacity:.95; margin:0 0 10px 0; font-weight:800}
    .cover-date{ font-size:18px; color:#6b7280; text-align:center }
    .cover-mark{ position:absolute; bottom:22px; left:0; right:0; text-align:center; font-size:12px; color:#6b7280 }

    @page{ size:A4; margin:14mm 12mm; }
    @media print{
      .header,.nav,.no-print,.modal{display:none!important}
      body{background:#fff}
      .card,.pyr,.seg,.print-card,.print-section,.avoid-break{break-inside:avoid;page-break-inside:avoid}
      .grid>.card{break-inside:avoid}
      .print-footer{
        position:fixed;left:0;right:0;bottom:0;padding:8px 0;text-align:center;
        font-size:10px;color:#6b7280;border-top:1px solid #e5e7eb;background:#fff
      }
    }
  </style>

  <!-- DÃ©pendances PDF (visuel fidÃ¨le) -->
  <script>
    function loadScript(src){
      return new Promise((resolve, reject)=>{
        const s=document.createElement('script'); s.src=src; s.defer=true;
        s.onload=resolve; s.onerror=()=>reject(new Error("load fail: "+src));
        document.head.appendChild(s);
      });
    }
    const depsReady = (async ()=>{
      if(!("html2canvas" in window)){
        await loadScript("https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js");
      }
      if(!(window.jspdf && window.jspdf.jsPDF)){
        await loadScript("https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js");
      }
      return true;
    })();
  </script>
</head>
<body>
<div class="app">
  <header class="header">
    <button class="btn btn-amber" id="btnHelp">â“ Aide</button>
    <button class="btn btn-red" id="btnHardReset">â™»ï¸ Reset</button>
  </header>

  <main class="main">
    <!-- PAGE 1 : COVER (app) -->
    <section id="page-cover" class="section">
      <div class="hero">
        <div>
          <h1>AcroJuge</h1>
          <p>Observer â€¢ Juger â€¢ Exporter</p>
          <button class="btn btn-green start" id="goSetup">Commencer</button>
        </div>
      </div>
    </section>

    <!-- PAGE 2 : CONFIG -->
    <section id="page-setup" class="section hidden">
      <div class="pageTitle">
        <h1>Configuration</h1>
        <div class="sub">Observateurs â€¢ Groupe â€¢ Plan dâ€™enchaÃ®nement</div>
      </div>

      <div class="row">
        <div class="col card">
          <div class="title">ğŸ‘€ ObservateurÂ·rice(s)</div>
          <input type="text" id="obsInput" placeholder="ex. Ambre, LÃ©o" />
          <div class="chips" id="obsChips"></div>
          <div class="muted">Colle une liste (virgule / point-virgule / retour ligne).</div>
        </div>
        <div class="col card">
          <div class="title">ğŸ‘¥ Groupe observÃ© (par dÃ©faut)</div>
          <input type="text" id="grpInput" placeholder="ex. InÃ¨s, LÃ©o" />
          <div class="chips" id="grpChips"></div>
          <div class="muted">Servira pour lâ€™Ã©valuation individuelle.</div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="bar">
          <div class="title">ğŸ—“ï¸ Plan dâ€™enchaÃ®nement (prochaine observation)</div>
          <div class="muted">Observations crÃ©Ã©es : <span id="compoCount">0</span></div>
        </div>
        <div class="grid" style="grid-template-columns:repeat(5,minmax(0,1fr));gap:10px;margin-top:8px">
          <div class="card p2"><label class="muted">Pyramide Ã  2 Ã—</label><input type="number" min="0" id="count-p2" placeholder=""></div>
          <div class="card p3"><label class="muted">Pyramide Ã  3 Ã—</label><input type="number" min="0" id="count-p3" placeholder=""></div>
          <div class="card p4"><label class="muted">Pyramide Ã  4 Ã—</label><input type="number" min="0" id="count-p4" placeholder=""></div>
          <div class="card p5"><label class="muted">Pyramide Ã  5 Ã—</label><input type="number" min="0" id="count-p5" placeholder=""></div>
          <div class="card libre"><label class="muted">Pyramide libre Ã—</label><input type="number" min="0" id="count-libre" placeholder=""></div>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn btn-gray" id="btnResetCounts">RÃ©initialiser</button>
          <button class="btn btn-green" id="btnStartObserve">â–¶ï¸ DÃ©marrer lâ€™observation</button>
        </div>
      </div>
    </section>

    <!-- PAGE 3 : OBSERVATION -->
    <section id="page-observe" class="section hidden">
      <div class="pageTitle">
        <h1>Observation</h1>
        <div class="sub">Tenue (3s) & SÃ©curitÃ© (ğŸ”´/ğŸŸ¡/ğŸŸ¢/ğŸŸ©) pour chaque pyramide</div>
      </div>

      <div id="observeContent" class="card"></div>

      <div class="nav">
        <button class="btn btn-gray" id="observeBack">â¬…ï¸ Configuration</button>
        <div class="row">
          <button class="btn btn-green" id="observeNext">Ã‰valuations â¡ï¸</button>
        </div>
      </div>
    </section>

    <!-- PAGE 4 : EVALUATIONS -->
    <section id="page-evals" class="section hidden">
      <div class="pageTitle">
        <h1>Ã‰valuations</h1>
        <div class="sub">Ensemble (ğŸ”´/ğŸŸ¡/ğŸŸ¢/ğŸŸ©) + Individuel /20</div>
      </div>

      <div class="card">
        <div class="title">ğŸ“ Ã‰valuation de lâ€™ensemble</div>
        <div id="ensembleFMB" class="grid grid-2" style="margin-top:8px"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="title">ğŸ‘¤ Ã‰valuation individuelle (note /20)</div>
        <div id="elevesList" class="grid grid-3"></div>
      </div>

      <div class="row" style="margin-top:12px; align-items:center">
        <div class="col card">
          <div class="title">ğŸ—’ï¸ Commentaire global</div>
          <textarea id="commentaire" placeholder="(facultatif)"></textarea>
        </div>
        <div class="col card">
          <div class="title">ğŸ Note finale /20</div>
          <input type="number" id="noteFinale" min="0" max="20" step="0.5" placeholder="â€”" />
          <div class="muted" style="margin-top:6px">Demi-points autorisÃ©s.</div>
        </div>
      </div>

      <div class="nav">
        <button class="btn btn-gray" id="evalsBack">â¬…ï¸ Observation</button>
        <div class="row" style="align-items:center">
          <button class="btn btn-blue" id="btnShowList">ğŸ“‚ EnchaÃ®nements</button>
          <button class="btn btn-amber" id="btnNewObservation">â• Nouvelle observation</button>
          <button class="btn btn-green" id="btnGoBilan">ğŸ“‘ Bilan (PDF)</button>
          <span id="exportTeamLabel" class="muted"></span>
        </div>
      </div>
    </section>

    <!-- PAGE 5 : BILAN -->
    <section id="page-bilan" class="section hidden">
      <div class="print-page">
        <div class="print-header">
          <div>
            <div class="print-title">Dossier dâ€™observation</div>
            <div class="print-sub" id="bilanSubtitle">Observateurs : â€”</div>
          </div>
          <div class="print-sub" id="bilanMeta">Date : â€”</div>
        </div>

        <div id="bilanContent"></div>

        <div class="nav" style="margin-top:14px">
          <button class="btn btn-gray" id="bilanBack">â¬…ï¸ Retour</button>
          <div class="row">
            <button class="btn btn-green-dark" id="bilanExportPDF">ğŸ“„ Exporter le PDF</button>
          </div>
        </div>
      </div>

      <div class="print-footer">AcroJuge â€“ Ã‰quipe EPS LycÃ©e Vauban â€“ LUXEMBOURG â€“ JB</div>
    </section>
  </main>

  <footer class="footer">
    AcroJuge â€“ Ã‰quipe EPS LycÃ©e Vauban â€“ LUXEMBOURG â€“ JB
  </footer>
</div>

<!-- Modals -->
<div class="modal" id="modalHelp">
  <div class="modal-card">
    <div class="bar">
      <h2 class="modal-title">Aide â€“ Comment utiliser AcroJuge</h2>
      <button class="btn btn-gray" id="helpClose">Fermer</button>
    </div>
    <div class="grid">
      <div class="card">
        <div class="title">1) Configuration</div>
        <ul>
          <li>Ajoute les <b>observateurs</b> (sÃ©parÃ©s par virgule, point-virgule ou retour Ã  la ligne).</li>
          <li>Ajoute le <b>groupe observÃ©</b> (prÃ©noms) : pour lâ€™Ã©valuation individuelle.</li>
          <li>Renseigne le <b>plan dâ€™enchaÃ®nement</b> : nombre de pyramides Ã  2 / 3 / 4 / 5 / libres.</li>
          <li>DÃ©marre lâ€™observation puis complÃ¨te <b>Observation</b> â†’ <b>Ã‰valuations</b>.</li>
        </ul>
      </div>
      <div class="card">
        <div class="title">2) Observation</div>
        <ul>
          <li>Pour chaque pyramide : <b>Tenue 3s</b> (OUI/NON) et <b>SÃ©curitÃ©</b> (ğŸ”´/ğŸŸ¡/ğŸŸ¢/ğŸŸ©) par critÃ¨re.</li>
          <li><b>Enregistrement automatique</b> (pas de bouton).</li>
        </ul>
      </div>
      <div class="card">
        <div class="title">3) Bilan PDF</div>
        <ul>
          <li>Cliquer <b>ğŸ“‘ Bilan</b> pour le rÃ©capitulatif.</li>
          <li><b>ğŸ“„ Exporter le PDF</b> : page de garde centrÃ©e (titre/prÃ©noms + date), pied de page centrÃ©, visuel fidÃ¨le.</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="modalList">
  <div class="modal-card">
    <div class="bar">
      <h2 class="modal-title">EnchaÃ®nements Ã©valuÃ©s</h2>
      <button class="btn btn-gray" id="listClose">Fermer</button>
    </div>
    <div id="listContainer" class="grid"></div>
  </div>
</div>

<script>
/* ===== PERSISTENCE ===== */
const STORAGE_KEY = "acrojuge_state_ui_v21_big_cover_no_blank_page";
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(app)); }
function load(){ try{ const raw=localStorage.getItem(STORAGE_KEY); if(raw) Object.assign(app, JSON.parse(raw)); }catch{} }
function hardReset(){
  if(!confirm("Tout rÃ©initialiser ? Cela efface toutes les observations enregistrÃ©es.")) return;
  localStorage.removeItem(STORAGE_KEY);
  Object.assign(app, freshApp());
  renderAll(); show("cover"); save();
}

/* ===== APP STATE ===== */
function freshApp(){
  return {
    observers: [],
    group: [],
    counts: {p2:0,p3:0,p4:0,p5:0,libre:0},
    evals: [],              // [{id,date,observerList,groupeList,pyramides[],ensemble:{},noteFinale,commentaire,eleves[],completed}]
    selectedId: null
  };
}
const app = freshApp();

/* ===== CONSTS ===== */
const LABEL = { p2:"Pyramide Ã  2", p3:"Pyramide Ã  3", p4:"Pyramide Ã  4", p5:"Pyramide Ã  5", libre:"Pyramide libre" };
const NEED  = { p2:2, p3:3, p4:4, p5:5 };
const COLORS= { p2:"p2", p3:"p3", p4:"p4", p5:"p5", libre:"libre" };
const DEFAULT_SECURITE = [
  "RÃ´les dÃ©finis (porteurs / voltige)",
  "Prises sÃ»res et alignements",
  "MontÃ©e contrÃ´lÃ©e",
  "Tenue sans danger",
  "Descente sÃ©curisÃ©e",
];
const ENSEMBLE_CRITS = ["Composition","EntrÃ©e","Sortie","OriginalitÃ©"];
const FMB_TEXT = { fragile:"Fragile", moyen:"Moyen", bon:"Bon", tb:"TrÃ¨s bon" };

/* ===== DOM ===== */
const $ = (id)=> document.getElementById(id);
document.addEventListener("DOMContentLoaded", async ()=>{
  if (navigator.storage && navigator.storage.persist) {
    try { await navigator.storage.persist(); } catch(e) {}
  }

  // Navigation
  $("goSetup").onclick     = ()=> show("setup");
  $("observeBack").onclick = ()=> show("setup");
  $("observeNext").onclick = ()=> show("evals");
  $("evalsBack").onclick   = ()=> show("observe");
  $("btnNewObservation").onclick = newObservationFlow;
  $("btnGoBilan").onclick  = ()=> { renderBilan(); show("bilan"); };
  $("bilanBack").onclick   = ()=> show("evals");
  $("bilanExportPDF").onclick = exportBilanPDF;

  // Modals
  $("btnHelp").onclick     = ()=> toggleModal("modalHelp", true);
  $("helpClose").onclick   = ()=> toggleModal("modalHelp", false);
  $("btnShowList").onclick = ()=> { renderListModal(); toggleModal("modalList", true); };
  $("listClose").onclick   = ()=> toggleModal("modalList", false);

  // Reset
  $("btnHardReset").onclick   = hardReset;
  $("btnResetCounts").onclick = ()=>{ app.counts={p2:0,p3:0,p4:0,p5:0,libre:0}; renderSetup(); save(); };

  // DÃ©marrer observation
  $("btnStartObserve").onclick= ()=>{
    if(!(app.observers && app.observers.filter(Boolean).length)){
      alert("Renseigne dâ€™abord les observateurs (au moins un prÃ©nom).");
      return;
    }
    addObservation(true);
  };

  // Chips
  const obsInput=$("obsInput"), grpInput=$("grpInput");
  obsInput.addEventListener("keydown",(e)=>{ if(["Enter",",",";"].includes(e.key)){ e.preventDefault(); addNames("observers", obsInput.value); obsInput.value=""; }});
  obsInput.addEventListener("paste",(e)=>{ const t=e.clipboardData?.getData("text")||""; if(/[,\n;]/.test(t)){ e.preventDefault(); addNames("observers", t); }});
  grpInput.addEventListener("keydown",(e)=>{ if(["Enter",",",";"].includes(e.key)){ e.preventDefault(); addNames("group", grpInput.value); grpInput.value=""; }});
  grpInput.addEventListener("paste",(e)=>{ const t=e.clipboardData?.getData("text")||""; if(/[,\n;]/.test(t)){ e.preventDefault(); addNames("group", t); }});

  // Compteurs
  ["p2","p3","p4","p5","libre"].forEach(k=>{
    $("count-"+k).addEventListener("input",(e)=>{ app.counts[k] = Math.max(0, Number(e.target.value)||0); save(); });
  });

  // Load & migrations
  load(); migrateObserverLists(); migrateCompleted(); save();
  renderAll(); show("cover");
});

function show(which){
  ["page-cover","page-setup","page-observe","page-evals","page-bilan"].forEach(id=>$(id).classList.add("hidden"));
  const map={cover:"page-cover",setup:"page-setup",observe:"page-observe",evals:"page-evals",bilan:"page-bilan"};
  $(map[which]).classList.remove("hidden");
}
function toggleModal(id,open){ $(id).classList.toggle("show", !!open); }

/* ===== HELPERS ===== */
function uid(){ return Math.random().toString(36).slice(2,10); }
function toChips(container, arr, onRemove){
  container.innerHTML = "";
  (arr||[]).forEach((name, i)=>{
    const s = document.createElement("span");
    s.className = "chip";
    s.innerHTML = `<span>${name}</span>`;
    const b = document.createElement("button");
    b.textContent = "Ã—";
    b.onclick = ()=>{ onRemove(i); };
    s.appendChild(b);
    container.appendChild(s);
  });
}
function splitNames(text){ return text.replace(/\r\n?/g,"\n").split(/[ ,;\n]+/).map(s=>s.trim()).filter(Boolean); }
function addNames(field, raw){
  const names = splitNames(raw);
  if(field==="observers"){ app.observers = [...app.observers, ...names.filter(n=>!app.observers.includes(n))]; }
  else { app.group = [...app.group, ...names.filter(n=>!app.group.includes(n))]; }
  renderSetup(); save();
}
function syncEleves(prev, names){ const by=new Map((prev||[]).map(e=>[e.name,e])); return (names||[]).map(n=> by.get(n) || { name:n, note:null }); }
function makePyramide(t){ const sec=Object.fromEntries(DEFAULT_SECURITE.map(s=>[s,"moyen"])); return { id:uid(), type:t, securite:sec, tenue:"non" }; }
function normalizeName(s=""){ return s.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim().replace(/\s+/g," "); }
function teamKey(arr=[]){ return (arr||[]).map(normalizeName).filter(Boolean).sort().join("|"); }

/* Auto-completed */
function computeCompleted(ev){
  if(!ev) return false;
  const hasGroup = (ev.groupeList||[]).length>0;
  const hasPyrs  = (ev.pyramides||[]).length>0;
  const anyTenue = (ev.pyramides||[]).some(p=>p.tenue==="oui");
  const anySecDiff = (ev.pyramides||[]).some(p=>Object.values(p.securite||{}).some(v=>v!=="moyen"));
  const anyEnsDiff = ev.ensemble && Object.values(ev.ensemble).some(v=>v!=="moyen");
  const anyIndiv   = (ev.eleves||[]).some(x=>x.note!=null);
  const hasFinal   = ev.noteFinale!=null || (ev.commentaire||"").trim()!=="";
  return !!(hasGroup && hasPyrs && (anyTenue || anySecDiff || anyEnsDiff || anyIndiv || hasFinal));
}
function touch(ev){ ev.completed = computeCompleted(ev); save(); }

/* ===== MIGRATIONS ===== */
function migrateObserverLists(){
  let lastTeam = (app.observers || []).filter(Boolean);
  (app.evals || []).forEach(ev=>{
    if(!ev.observerList || ev.observerList.filter(Boolean).length===0){
      ev.observerList = (lastTeam && lastTeam.length) ? [...lastTeam] : [...(app.observers||[])];
    } else {
      lastTeam = [...ev.observerList];
    }
  });
}
function migrateCompleted(){
  (app.evals || []).forEach(ev=>{
    if (ev.completed === undefined){
      ev.completed = computeCompleted(ev);
    }
  });
}
function countObservationsForTeam(team=[]){
  const k = teamKey(team);
  if(!k) return 0;
  return (app.evals||[]).filter(e => teamKey(e.observerList||[])===k).length;
}

/* ===== EXPORT TEAM DETECTION ===== */
function buildTeamsIndex(){
  const map = new Map();
  (app.evals||[]).forEach(ev=>{
    const k = teamKey(ev.observerList||[]);
    if(!k) return;
    if(!map.has(k)) map.set(k, { names:[...(ev.observerList||[])], count:0 });
    map.get(k).count++;
  });
  return map;
}
function getCurrentExportTeam(){
  const cur = (app.evals||[]).find(e=>e.id===app.selectedId);
  if(cur && (cur.observerList||[]).length) return [...cur.observerList];
  const idx = buildTeamsIndex();
  const confKey = teamKey(app.observers||[]);
  if(confKey && idx.has(confKey)) return [...(idx.get(confKey).names||[])];
  let best = null; let bestCount = -1;
  for (const [, val] of idx.entries()){
    if(val.count > bestCount){ best = val; bestCount = val.count; }
  }
  if(best) return [...(best.names||[])];
  return [];
}

/* ===== RENDER ===== */
function renderAll(){ renderSetup(); renderObserve(); renderEvals(); }

function renderSetup(){
  toChips($("obsChips"), app.observers, (i)=>{ app.observers.splice(i,1); renderSetup(); save(); });
  toChips($("grpChips"), app.group, (i)=>{ app.group.splice(i,1); renderSetup(); save(); });
  $("compoCount").textContent = app.evals.length;
  ["p2","p3","p4","p5","libre"].forEach(k=>{
    const v = app.counts[k];
    const el = $("count-"+k);
    el.value = v>0 ? v : "";
  });
}

function renderObserve(){
  const observeContent=$("observeContent");
  observeContent.innerHTML = "";
  const ev = app.evals.find(e=>e.id===app.selectedId);
  if(!ev){ observeContent.innerHTML = `<div class="muted">DÃ©marre une observation pour crÃ©er le premier enchaÃ®nement.</div>`; return; }

  const grpCard=document.createElement("div");
  grpCard.className="card";
  grpCard.innerHTML = `
    <div class="bar">
      <div class="title">ğŸ‘¥ Groupe de lâ€™observation</div>
      ${ev.completed ? '<span class="muted">âœ… EnregistrÃ©e</span>' : ''}
    </div>
    <input type="text" id="grpEdit" placeholder="ex. InÃ¨s, LÃ©o" />
    <div class="chips" id="grpEditChips"></div>
  `;
  observeContent.appendChild(grpCard);
  const grpEdit=grpCard.querySelector("#grpEdit");
  const grpEditChips=grpCard.querySelector("#grpEditChips");
  toChips(grpEditChips, ev.groupeList||[], (i)=>{ ev.groupeList.splice(i,1); ev.eleves=syncEleves(ev.eleves, ev.groupeList); touch(ev); renderObserve(); });
  grpEdit.addEventListener("keydown",(e)=>{ if(["Enter",",",";"].includes(e.key)){ e.preventDefault(); const names=splitNames(grpEdit.value); ev.groupeList=[...(ev.groupeList||[]), ...names.filter(n=>!(ev.groupeList||[]).includes(n))]; ev.eleves=syncEleves(ev.eleves, ev.groupeList); grpEdit.value=""; touch(ev); renderObserve(); }});
  grpEdit.addEventListener("paste",(e)=>{ const t=e.clipboardData?.getData("text")||""; if(/[,\n;]/.test(t)){ e.preventDefault(); const names=splitNames(t); ev.groupeList=[...(ev.groupeList||[]), ...names.filter(n=>!(ev.groupeList||[]).includes(n))]; ev.eleves=syncEleves(ev.eleves, ev.groupeList); touch(ev); renderObserve(); }});

  const wrap=document.createElement("div"); wrap.className="grid grid-2";
  ev.pyramides.forEach((p, idx)=>{
    const el=document.createElement("div"); el.className=`pyr ${COLORS[p.type]} avoid-break`;
    el.innerHTML = `
      <div class="bar"><div class="title">#${idx+1} â€” ${LABEL[p.type]}</div><div class="muted">${NEED[p.type]? NEED[p.type]+" Ã©lÃ¨ves":"libre"}</div></div>
      <div class="seg">
        <div class="title" style="font-size:14px">â±ï¸ Tenue 3s</div>
        <div class="row">
          <button class="btn ${p.tenue==='oui'?'btn-green':'btn-gray'}" data-tn="oui">OUI</button>
          <button class="btn ${p.tenue==='non'?'btn-red':'btn-gray'}" data-tn="non">NON</button>
        </div>
      </div>
      <div class="seg avoid-break">
        <div class="title" style="font-size:14px">ğŸ”’ SÃ©curitÃ©</div>
        <div class="grid">
          ${DEFAULT_SECURITE.map((crit)=>`
            <div class="card" style="padding:8px">
              <div class="muted" style="margin-bottom:6px">${crit}</div>
              <div class="fmblist row">
                <button data-fmb="fragile" class="${p.securite[crit]==='fragile'?'active':''}">ğŸ”´ Fragile</button>
                <button data-fmb="moyen"   class="${p.securite[crit]==='moyen'  ?'active':''}">ğŸŸ¡ Moyen</button>
                <button data-fmb="bon"     class="${p.securite[crit]==='bon'    ?'active':''}">ğŸŸ¢ Bon</button>
                <button data-fmb="tb"      class="${p.securite[crit]==='tb'     ?'active':''}">ğŸŸ© TrÃ¨s bon</button>
              </div>
            </div>
          `).join("")}
        </div>
      </div>`;
    el.querySelectorAll("[data-tn]").forEach(btn=>{
      btn.onclick = ()=>{ p.tenue = btn.getAttribute("data-tn"); touch(ev); renderObserve(); };
    });
    el.querySelectorAll(".fmblist").forEach((rowEl,i)=>{
      rowEl.querySelectorAll("[data-fmb]").forEach(b=>{
        b.onclick = ()=>{
          const val=b.getAttribute("data-fmb"); const crit=DEFAULT_SECURITE[i];
          p.securite[crit]=val; touch(ev); renderObserve();
        };
      });
    });
    wrap.appendChild(el);
  });
  observeContent.appendChild(wrap);
}

function renderEvals(){
  const ev = app.evals.find(e=>e.id===app.selectedId); if(!ev) return;

  const cont=$("ensembleFMB");
  cont.innerHTML="";
  if(!ev.ensemble) ev.ensemble = Object.fromEntries(ENSEMBLE_CRITS.map(c=>[c,"moyen"]));
  ENSEMBLE_CRITS.forEach((crit)=>{
    const card = document.createElement("div"); card.className="card avoid-break";
    card.innerHTML = `
      <div class="bar">
        <div class="title" style="font-size:14px">${crit}</div>
        ${ev.completed ? '<span class="muted">âœ… EnregistrÃ©e</span>' : ''}
      </div>
      <div class="fmblist row">
        <button data-fmb="fragile" class="${ev.ensemble[crit]==='fragile'?'active':''}">ğŸ”´ Fragile</button>
        <button data-fmb="moyen"   class="${ev.ensemble[crit]==='moyen'  ?'active':''}">ğŸŸ¡ Moyen</button>
        <button data-fmb="bon"     class="${ev.ensemble[crit]==='bon'    ?'active':''}">ğŸŸ¢ Bon</button>
        <button data-fmb="tb"      class="${ev.ensemble[crit]==='tb'     ?'active':''}">ğŸŸ© TrÃ¨s bon</button>
      </div>`;
    card.querySelectorAll("[data-fmb]").forEach(b=>{
      b.onclick = ()=>{ ev.ensemble[crit] = b.getAttribute("data-fmb"); touch(ev); renderEvals(); };
    });
    cont.appendChild(card);
  });

  const elevesList=$("elevesList");
  elevesList.innerHTML="";
  (ev.eleves||[]).forEach((el, idx)=>{
    const item=document.createElement("div"); item.className="note-item avoid-break";
    item.innerHTML = `
      <div class="who">${el.name}</div>
      <input type="number" min="0" max="20" step="0.5" placeholder="â€”" value="${el.note ?? ''}" data-note="${idx}" />
    `;
    item.querySelector(`[data-note="${idx}"]`).oninput = (e)=>{
      const v=e.target.value;
      const n = v===''? null : Math.min(20, Math.max(0, Math.round((Number(v)||0)*2)/2));
      el.note = n; touch(ev);
    };
    elevesList.appendChild(item);
  });

  const commentaire=$("commentaire"), noteFinale=$("noteFinale");
  commentaire.value = ev.commentaire??""; commentaire.oninput = (e)=>{ ev.commentaire=e.target.value; touch(ev); };
  noteFinale.value = ev.noteFinale ?? "";
  noteFinale.oninput = (e)=>{
    const v=e.target.value;
    const n = v===''? null : Math.min(20, Math.max(0, Math.round((Number(v)||0)*2)/2));
    ev.noteFinale = n; touch(ev);
  };

  const lab = document.getElementById("exportTeamLabel");
  if(lab){
    const t = getCurrentExportTeam();
    const n = countObservationsForTeam(t);
    lab.textContent = t.length ? `Bilan : Observateurs = ${t.join(", ")} â€¢ ${n} observation(s)` : "";
  }
}

/* ===== LIST MODAL ===== */
function renderListModal(){
  const cont = $("listContainer");
  cont.innerHTML = "";
  if(!app.evals.length){
    cont.innerHTML = `<div class="muted">Aucun enchaÃ®nement pour le moment.</div>`;
    return;
  }
  app.evals.forEach((ev, idx)=>{
    const cnt = { p2:0,p3:0,p4:0,p5:0,libre:0 };
    (ev.pyramides||[]).forEach(p=> cnt[p.type]++);
    const row = document.createElement("div");
    row.className = "list-row";
    row.innerHTML = `
      <div>
        <div><b>${idx+1}.</b> Groupe: ${(ev.groupeList||[]).join(", ")||"(Ã  complÃ©ter)"} ${ev.completed? 'â€” âœ…':''}</div>
        <div class="muted">Obs: ${(ev.observerList||[]).join(", ")||"â€”"}</div>
        <div class="muted">P2:${cnt.p2} P3:${cnt.p3} P4:${cnt.p4} P5:${cnt.p5} L:${cnt.libre}</div>
      </div>
      <div class="row">
        <button class="btn btn-blue" data-open="${ev.id}">Ouvrir</button>
      </div>
    `;
    row.querySelector(`[data-open="${ev.id}"]`).onclick = ()=>{
      app.selectedId = ev.id;
      toggleModal("modalList", false);
      renderObserve(); renderEvals(); save();
    };
    cont.appendChild(row);
  });
}

/* ===== ACTIONS ===== */
function addObservation(goToObserve){
  const list = [
    ...Array.from({length:app.counts.p2},()=> "p2"),
    ...Array.from({length:app.counts.p3},()=> "p3"),
    ...Array.from({length:app.counts.p4},()=> "p4"),
    ...Array.from({length:app.counts.p5},()=> "p5"),
    ...Array.from({length:app.counts.libre},()=> "libre"),
  ];
  const pyramides = list.map(makePyramide);
  const ev = {
    id:uid(), date:new Date().toISOString(),
    observerList:[...app.observers], groupeList:[...app.group],
    pyramides,
    ensemble: Object.fromEntries(ENSEMBLE_CRITS.map(c=>[c,"moyen"])),
    noteFinale: null, commentaire:"",
    eleves: syncEleves([], app.group),
    completed: false,
  };
  app.evals.unshift(ev);
  app.selectedId = ev.id;
  renderSetup(); renderObserve(); renderEvals(); save();
  if(goToObserve) show("observe");
}

function newObservationFlow(){
  app.group = [];
  app.counts = {p2:0,p3:0,p4:0,p5:0,libre:0};
  renderSetup(); save();
  show("setup");
}

/* ===== BILAN (construction) ===== */
function getTeamSelection(){
  const team = getCurrentExportTeam();
  const k = teamKey(team);
  const selection = (app.evals||[]).filter(e => teamKey(e.observerList||[])===k);
  return { team, selection };
}

function renderBilan(){
  const { team, selection } = getTeamSelection();
  $("bilanSubtitle").textContent = team.length ? `Observateurs : ${team.join(", ")} â€¢ ${selection.length} observation(s)` : "Aucune Ã©quipe dÃ©tectÃ©e";
  $("bilanMeta").textContent = `Date : ${new Date().toLocaleDateString()}`;

  const cont = $("bilanContent"); cont.innerHTML = "";
  if(!selection.length){
    cont.innerHTML = `<div class="print-card muted">Aucune observation trouvÃ©e pour cette Ã©quipe.</div>`;
    return;
  }

  selection.forEach((e, idx)=>{
    const header = document.createElement("div");
    header.className = "print-section avoid-break" + (idx>0 ? " group-start" : "");
    header.dataset.block = "group-header";
    header.textContent = `#${idx+1} â€” Groupe observÃ© : ${(e.groupeList||[]).join(", ")||"(Ã  complÃ©ter)"} ${e.completed? 'âœ…':''}`;
    cont.appendChild(header);

    const obs = document.createElement("div");
    obs.className = "print-card avoid-break";
    obs.innerHTML = `<div class="title">OBSERVATIONS (pyramides)</div>`;
    (e.pyramides||[]).forEach((p,iP)=>{
      const block = document.createElement("div");
      block.className = `pyr ${COLORS[p.type]} avoid-break`;
      block.style.marginTop = "8px";
      block.innerHTML = `
        <div class="bar"><div><b>Pyramide ${iP+1}</b> â€” ${LABEL[p.type]}</div>
        <div class="muted">${NEED[p.type]? NEED[p.type]+" Ã©lÃ¨ves":"libre"}</div></div>
        <div class="muted" style="margin-top:6px">Tenue 3s : <b>${String(p.tenue||"non").toUpperCase()}</b></div>
        <ul style="margin:8px 0 0 14px">
          ${Object.entries(p.securite||{}).map(([crit,lv])=>{
            const colorClass = lv==="fragile"?"red":lv==="moyen"?"amber":lv==="bon"?"green":"teal";
            return `<li class="avoid-break"><span class="dot ${colorClass}"></span>${crit} â€” <i>${FMB_TEXT[lv]||lv}</i></li>`;
          }).join("")}
        </ul>
      `;
      obs.appendChild(block);
    });
    cont.appendChild(obs);

    const eva = document.createElement("div");
    eva.className = "print-card avoid-break";
    eva.innerHTML = `<div class="title">Ã‰VALUATIONS</div><div><b>Ensemble :</b></div>`;
    const ulEns = document.createElement("ul");
    ulEns.style.margin = "6px 0 10px 16px";
    ENSEMBLE_CRITS.forEach(c=>{
      const lv=(e.ensemble||{})[c]||"moyen";
      const colorClass = lv==="fragile"?"red":lv==="moyen"?"amber":lv==="bon"?"green":"teal";
      const li = document.createElement("li");
      li.className = "avoid-break";
      li.innerHTML = `<span class="dot ${colorClass}"></span>${c} : <i>${FMB_TEXT[lv]||lv}</i>`;
      ulEns.appendChild(li);
    });
    eva.appendChild(ulEns);

    if ((e.eleves||[]).length){
      const wrap = document.createElement("div");
      wrap.innerHTML = `<div><b>Individuelle (/20) :</b></div>`;
      const ulInd = document.createElement("ul");
      ulInd.style.margin = "6px 0 0 16px";
      (e.eleves||[]).forEach(el=>{
        const n = el.note==null ? "â€”" : String(Number(el.note).toFixed(1)).replace(".",",");
        const li = document.createElement("li");
        li.className = "avoid-break";
        li.textContent = `${el.name} : ${n}/20`;
        ulInd.appendChild(li);
      });
      wrap.appendChild(ulInd);
      eva.appendChild(wrap);
    }

    const nf = e.noteFinale==null ? "â€”" : String(Number(e.noteFinale).toFixed(1)).replace(".",",");
    const nfDiv = document.createElement("div");
    nfDiv.style.marginTop = "8px";
    nfDiv.innerHTML = `<b>Note finale /20 :</b> ${nf}`;
    eva.appendChild(nfDiv);

    if ((e.commentaire||"").trim()){
      const comDiv = document.createElement("div");
      comDiv.style.marginTop = "6px";
      comDiv.innerHTML = `<b>Commentaire :</b> ${e.commentaire}`;
      eva.appendChild(comDiv);
    }

    cont.appendChild(eva);
  });
}

/* ===== EXPORT PDF ===== */
async function exportBilanPDF(){
  const ok = await depsReady.catch(()=>false);
  if(!ok){ alert("DÃ©pendances PDF non chargÃ©es."); return; }

  const team = (function(){
    const t = getCurrentExportTeam();
    return (t||[]).filter(Boolean);
  })();
  if(!team.length){ alert("Aucune Ã©quipe dâ€™observateurs dÃ©tectÃ©e."); return; }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: "pt", format: "a4" }); // 595 x 842 pt
  const pageW = doc.internal.pageSize.getWidth();
  const pageH = doc.internal.pageSize.getHeight();
  const margin = 40;
  let y = margin;

  const orphanAfterHeaderMin = 240;

  function footerTextFor(p,total){
    return `AcroJuge â€“ Ã‰quipe EPS LycÃ©e Vauban â€“ LUXEMBOURG â€“ JB  â€¢  Page ${p}/${total}  â€¢  ${new Date().toLocaleDateString()}`;
  }
  function drawFooterCentered(p){
    const total = doc.getNumberOfPages();
    doc.setFont("helvetica","normal"); doc.setFontSize(9); doc.setTextColor(120);
    doc.text(footerTextFor(p,total), pageW/2, pageH - 16, { align:"center", baseline:"alphabetic" });
    doc.setTextColor(0);
  }
  function newPage(){
    const cur = doc.internal.getCurrentPageInfo().pageNumber;
    drawFooterCentered(cur);
    doc.addPage(); y = margin;
  }
  function spaceLeft(){ return pageH - margin - 20 - y; }

  const retinaScale = Math.min(2, window.devicePixelRatio || 1.5);

  async function snapEl(el){
    const canvas = await html2canvas(el, {
      backgroundColor: null,
      scale: retinaScale,
      useCORS: true,
      windowWidth: document.documentElement.scrollWidth,
      windowHeight: document.documentElement.scrollHeight
    });
    const imgData = canvas.toDataURL("image/png");
    const fullW = pageW - margin*2;
    const ratio = canvas.height / canvas.width;
    const fullH = fullW * ratio;
    return { imgData, imgW: fullW, imgH: fullH, ratio };
  }

  async function addBlock(el){
    const isHeader = el.dataset && el.dataset.block === "group-header";
    const shot = await snapEl(el);
    const { imgData, imgW, imgH, ratio } = shot;

    if (isHeader && y !== margin) newPage();
    if (isHeader && spaceLeft() < orphanAfterHeaderMin) newPage();

    if (imgH > spaceLeft()){
      const maxH = pageH - margin*2;
      if (imgH > maxH){
        const fitH = maxH, fitW = fitH / ratio;
        if (fitH > spaceLeft()) newPage();
        doc.addImage(imgData, "PNG", margin, y, fitW, fitH, undefined, "FAST");
        y += fitH + 8;
        return;
      }
      newPage();
    }

    doc.addImage(imgData, "PNG", margin, y, imgW, imgH, undefined, "FAST");
    y += imgH + 8;
  }

  // 0) Construire le bilan (derniÃ¨re version)
  renderBilan();

  // 1) COUVERTURE offscreen (gros titre + prÃ©noms + date)
  const cover = document.createElement("div");
  cover.className = "cover-root";
  cover.innerHTML = `
    <span class="cover-badge">AcroJuge</span>
    <h1 class="cover-title">Dossier dâ€™observation de :</h1>
    <div class="cover-names">${team.join(", ") || "Observateurs"}</div>
    <div class="cover-date">${new Date().toLocaleDateString()}</div>
    <div class="cover-mark">AcroJuge â€“ Ã‰quipe EPS LycÃ©e Vauban â€“ LUXEMBOURG â€“ JB</div>
  `;
  document.body.appendChild(cover);

  // 2) Snap couverture â†’ page 1
  const coverShot = await snapEl(cover);
  document.body.removeChild(cover);
  const maxW = pageW - margin*2, maxH = pageH - margin*2;
  let w = coverShot.imgW, h = coverShot.imgH;
  const scale = Math.min(maxW / w, maxH / h);
  w *= scale; h *= scale;
  const x = (pageW - w)/2, top = (pageH - h)/2;
  doc.addImage(coverShot.imgData, "PNG", x, top, w, h, undefined, "FAST");

  // 3) RÃ©cupÃ©rer les blocs (groupes/observations/Ã©valuations)
  const blocks = Array.from(document.querySelectorAll("#bilanContent > *"));

  // 4) On nâ€™ajoute une page que sâ€™il y a des blocs Ã  rendre
  if (blocks.length){
    newPage();
    // (pas de petit print-header pour Ã©viter une page quasi vide)
    for (const b of blocks){ await addBlock(b); }
  }

  // 5) Pieds de page centrÃ©s
  const total = doc.getNumberOfPages();
  for(let p=1;p<=total;p++){ doc.setPage(p); drawFooterCentered(p); }

  // 6) Nom de fichier
  const safeTeam = team.join("-").replace(/[^\w-]+/g,"-").replace(/-+/g,"-");
  const date = new Date().toISOString().slice(0,10);
  doc.save(`AcroJuge-${safeTeam||"Observateurs"}-${date}.pdf`);
}
</script>
</body>
</html>
